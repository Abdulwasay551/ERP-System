{% extends 'base.html' %}
{% load static %}

{% block title %}Purchase Bills Management{% endblock %}

{% block extra_css %}
<style>
    .bills-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .header-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 1rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .header-section h1 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .header-section p {
        margin: 0.75rem 0 0 0;
        font-size: 1.125rem;
        opacity: 0.9;
    }
    
    .card-modern {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e5e7eb;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        color: white;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        color: white;
        text-decoration: none;
    }
    
    .btn-secondary {
        background: white;
        border: 1px solid #d1d5db;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 500;
        color: #374151;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
        background: #f9fafb;
        border-color: #9ca3af;
        color: #374151;
        text-decoration: none;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #3b82f6;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #6b7280;
        font-weight: 500;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .filter-section {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: end;
    }
    
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
    
    .filter-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
    }
    
    .filter-input, .filter-select {
        width: 100%;
        padding: 0.75rem;
        border-radius: 0.5rem;
        border: 1px solid #d1d5db;
        transition: all 0.3s ease;
    }
    
    .filter-input:focus, .filter-select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .table-container {
        overflow-x: auto;
        border-radius: 1rem;
        border: 1px solid #e5e7eb;
    }
    
    .modern-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }
    
    .modern-table th {
        background: #f9fafb;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 1px solid #e5e7eb;
        white-space: nowrap;
    }
    
    .modern-table td {
        padding: 1rem;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
    }
    
    .modern-table tbody tr:hover {
        background: #f9fafb;
    }
    
    .status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .status-draft { background-color: #f3f4f6; color: #6b7280; }
    .status-submitted { background-color: #cffafe; color: #0891b2; }
    .status-approved { background-color: #d1fae5; color: #059669; }
    .status-paid { background-color: #d1fae5; color: #047857; }
    .status-partially-paid { background-color: #fef3c7; color: #d97706; }
    .status-overdue { background-color: #fee2e2; color: #dc2626; }
    .status-cancelled { background-color: #fee2e2; color: #dc2626; }
    
    .matching-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .matching-three-way { background-color: #d1fae5; color: #047857; }
    .matching-two-way { background-color: #cffafe; color: #0891b2; }
    .matching-standalone { background-color: #f3f4f6; color: #6b7280; }
    
    .action-buttons {
        display: flex;
        gap: 0.25rem;
        align-items: center;
    }
    
    .action-btn {
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }
    
    .action-btn-primary {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }
    
    .action-btn-primary:hover {
        background: #2563eb;
        color: white;
        text-decoration: none;
    }
    
    .action-btn-warning {
        background: #f59e0b;
        color: white;
        border-color: #f59e0b;
    }
    
    .action-btn-success {
        background: #10b981;
        color: white;
        border-color: #10b981;
    }
    
    .action-btn-info {
        background: #06b6d4;
        color: white;
        border-color: #06b6d4;
    }
    
    .action-btn-secondary {
        background: #6b7280;
        color: white;
        border-color: #6b7280;
    }
    
    .amount-cell {
        text-align: right;
        font-weight: 600;
        font-family: 'Monaco', 'Menlo', monospace;
    }
    
    .amount-outstanding { color: #dc2626; }
    .amount-paid { color: #059669; }
    
    .no-data {
        text-align: center;
        padding: 3rem;
        color: #6b7280;
    }
    
    .no-data-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
    }
    
    .pagination {
        display: flex;
        gap: 0.25rem;
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .pagination .page-item .page-link {
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid #d1d5db;
        color: #374151;
        text-decoration: none;
        transition: all 0.2s ease;
    }
    
    .pagination .page-item.active .page-link {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }
    
    .pagination .page-item .page-link:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
        text-decoration: none;
    }
    
    .dropdown {
        position: relative;
        display: inline-block;
    }
    
    .dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        z-index: 1000;
        display: none;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        padding: 0.5rem 0;
        min-width: 200px;
        margin-top: 0.25rem;
    }
    
    .dropdown-menu.show {
        display: block;
    }
    
    .dropdown-item {
        padding: 0.5rem 1rem;
        color: #374151;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
    }
    
    .dropdown-item:hover {
        background: #f3f4f6;
        color: #374151;
        text-decoration: none;
    }
    
    .dropdown-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 0.5rem 0;
    }
    
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1055;
        width: 100%;
        height: 100%;
        overflow-x: hidden;
        overflow-y: auto;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
    }
    
    .modal.show {
        display: flex !important;
        align-items: center;
        justify-content: center;
    }
    
    .modal-dialog {
        max-width: 500px;
        margin: 1.75rem auto;
        position: relative;
        width: auto;
        pointer-events: none;
    }
    
    .modal-content {
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        pointer-events: auto;
        position: relative;
        display: flex;
        flex-direction: column;
        width: 100%;
        outline: 0;
    }
    
    .modal-header {
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .modal-title {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
    }
    
    .modal-body {
        padding: 1rem;
    }
    
    .modal-footer {
        padding: 1rem;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }
    
    .btn-close {
        background: transparent;
        border: none;
        font-size: 1.25rem;
        cursor: pointer;
        opacity: 0.5;
    }
    
    .btn-close:hover {
        opacity: 0.75;
    }
    
    .btn {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-secondary {
        background: #6b7280;
        color: white;
        border-color: #6b7280;
    }
    
    .btn-secondary:hover {
        background: #4b5563;
        border-color: #4b5563;
    }
    
    .btn-success {
        background: #10b981;
        color: white;
        border-color: #10b981;
    }
    
    .btn-success:hover {
        background: #059669;
        border-color: #059669;
    }
    
    .btn-danger {
        background: #ef4444;
        color: white;
        border-color: #ef4444;
    }
    
    .text-danger { color: #dc2626; }
    .text-success { color: #059669; }
    .text-warning { color: #d97706; }
    .text-muted { color: #6b7280; }
    
    .font-weight-bold { font-weight: 700; }
    .font-weight-medium { font-weight: 500; }
</style>
{% endblock %}

{% block content %}
<div class="bills-container">
    <!-- Header Section -->
    <div class="header-section">
        <div class="header-content">
            <div>
                <h1><i class="fas fa-file-invoice-dollar"></i> Purchase Bills</h1>
                <p>Manage purchase invoices, bills, and supplier payments with three-way matching</p>
            </div>
            <div>
                <a href="javascript:void(0)" onclick="openBillForm()" class="btn-primary">
                    <i class="fas fa-plus"></i> Create New Bill
                </a>
            </div>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ bills.paginator.count }}</div>
            <div class="stat-label">Total Bills</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ bills|length }}</div>
            <div class="stat-label">This Page</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">
                {% for bill in bills %}
                    {% if bill.status == 'draft' %}{{ forloop.counter }}{% endif %}
                {% empty %}0{% endfor %}
            </div>
            <div class="stat-label">Draft Bills</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">
                {% for bill in bills %}
                    {% if bill.status == 'approved' %}{{ forloop.counter }}{% endif %}
                {% empty %}0{% endfor %}
            </div>
            <div class="stat-label">Approved Bills</div>
        </div>
    </div>
    
    <!-- Filter Section -->
    <div class="card-modern">
        <form method="get" class="filter-section">
            <div class="filter-group">
                <label class="filter-label">Search</label>
                <input type="text" name="search" class="filter-input" 
                       placeholder="Search bills by number, supplier, or invoice number..." 
                       value="{{ search_query }}">
            </div>
            <div class="filter-group">
                <label class="filter-label">Status</label>
                <select name="status" class="filter-select">
                    <option value="">All Statuses</option>
                    {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Supplier</label>
                <select name="supplier" class="filter-select">
                    <option value="">All Suppliers</option>
                    {% for supplier in suppliers %}
                        <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-search"></i> Filter
                </button>
                <a href="?" class="btn-secondary">Clear</a>
            </div>
        </form>
    </div>
    
    <!-- Bills Table -->
    <div class="card-modern">
        {% if bills %}
            <div class="table-container">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Bill Number</th>
                            <th>Supplier</th>
                            <th>Invoice Number</th>
                            <th>Bill Date</th>
                            <th>Due Date</th>
                            <th>Total Amount</th>
                            <th>Outstanding</th>
                            <th>Status</th>
                            <th>Matching</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bill in bills %}
                            <tr>
                                <td>
                                    <div class="font-weight-bold">{{ bill.bill_number }}</div>
                                    {% if bill.supplier_invoice %}
                                        <small class="text-muted">
                                            <i class="fas fa-paperclip"></i> Has Invoice
                                        </small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="font-weight-bold">{{ bill.supplier.name }}</div>
                                    <small class="text-muted">{{ bill.supplier.email }}</small>
                                </td>
                                <td>{{ bill.supplier_invoice_number|default:"-" }}</td>
                                <td>{{ bill.bill_date|date:"M d, Y" }}</td>
                                <td>
                                    {{ bill.due_date|date:"M d, Y" }}
                                    {% if bill.is_overdue %}
                                        <br><small class="text-danger">
                                            <i class="fas fa-exclamation-triangle"></i> Overdue
                                        </small>
                                    {% endif %}
                                </td>
                                <td class="amount-cell">${{ bill.total_amount|floatformat:2 }}</td>
                                <td class="amount-cell">
                                    <span class="{% if bill.outstanding_amount > 0 %}amount-outstanding{% else %}amount-paid{% endif %}">
                                        ${{ bill.outstanding_amount|floatformat:2 }}
                                    </span>
                                </td>
                                <td>
                                    <span class="status-badge status-{{ bill.status }}">
                                        {{ bill.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    <span class="matching-badge matching-{{ bill.matching_type|default:'standalone' }}">
                                        {{ bill.get_matching_type_display|default:'Standalone' }}
                                    </span>
                                    {% if bill.matching_type == 'three_way' %}
                                        <br><small class="text-muted">
                                            {% if bill.three_way_match_status %}
                                                <i class="fas fa-check text-success"></i> Matched
                                            {% else %}
                                                <i class="fas fa-exclamation-triangle text-warning"></i> Pending
                                            {% endif %}
                                        </small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{% url 'purchase:bill_detail' bill.pk %}" target="_blank" 
                                           class="action-btn action-btn-primary" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if bill.status == 'draft' %}
                                            <a href="javascript:void(0)" onclick="editBill({{ bill.pk }})" 
                                               class="action-btn action-btn-warning" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        {% endif %}
                                        {% if bill.can_approve and perms.purchase.approve_bill %}
                                            <button type="button" onclick="approveBill({{ bill.pk }})" 
                                                    class="action-btn action-btn-success" title="Approve">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        {% endif %}
                                        {% if bill.outstanding_amount > 0 %}
                                            <a href="javascript:void(0)" onclick="createPayment({{ bill.pk }})" 
                                               class="action-btn action-btn-info" title="Create Payment">
                                                <i class="fas fa-dollar-sign"></i>
                                            </a>
                                        {% endif %}
                                        <div class="dropdown">
                                            <button type="button" class="action-btn action-btn-secondary dropdown-toggle" 
                                                    onclick="toggleDropdown(this)" aria-haspopup="true" aria-expanded="false">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="{% url 'purchase:bill_detail' bill.pk %}">
                                                    <i class="fas fa-print"></i> Print/PDF
                                                </a></li>
                                                {% if bill.purchase_order %}
                                                    <li><a class="dropdown-item" href="{% url 'purchase:purchase_order_detail' bill.purchase_order.pk %}">
                                                        <i class="fas fa-shopping-cart"></i> View PO
                                                    </a></li>
                                                {% endif %}
                                                {% if bill.grn %}
                                                    <li><a class="dropdown-item" href="{% url 'purchase:grn_detail' bill.grn.pk %}">
                                                        <i class="fas fa-truck"></i> View GRN
                                                    </a></li>
                                                {% endif %}
                                                <li><hr class="dropdown-divider"></li>
                                                {% if bill.status == 'draft' %}
                                                    <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="deleteBill({{ bill.pk }})">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </a></li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            {% if bills.has_other_pages %}
                <div class="pagination-container">
                    <ul class="pagination">
                        {% if bills.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                                    <i class="fas fa-angle-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ bills.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                                    <i class="fas fa-angle-left"></i>
                                </a>
                            </li>
                        {% endif %}
                        
                        {% for num in bills.paginator.page_range %}
                            {% if bills.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > bills.number|add:'-3' and num < bills.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if bills.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ bills.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                                    <i class="fas fa-angle-right"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ bills.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                                    <i class="fas fa-angle-double-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            {% endif %}
        {% else %}
            <div class="no-data">
                <div class="no-data-icon">
                    <i class="fas fa-file-invoice"></i>
                </div>
                <h3>No Bills Found</h3>
                <p>No bills match your current filters. Try adjusting your search criteria or create a new bill.</p>
                <a href="javascript:void(0)" onclick="openBillForm()" class="btn-primary">
                    <i class="fas fa-plus"></i> Create First Bill
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Confirmation Modals -->
<div class="modal" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="approveModalLabel">Approve Bill</h5>
                <button type="button" class="btn-close" onclick="closeModal('approveModal')" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to approve this bill? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('approveModal')">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmApprove">Approve Bill</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Delete Bill</h5>
                <button type="button" class="btn-close" onclick="closeModal('deleteModal')" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this bill? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete Bill</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Custom dropdown functionality
function toggleDropdown(button) {
    const dropdown = button.nextElementSibling;
    const isOpen = dropdown.classList.contains('show');
    
    // Close all other dropdowns
    document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
        menu.classList.remove('show');
    });
    
    // Toggle current dropdown
    if (!isOpen) {
        dropdown.classList.add('show');
        
        // Close dropdown when clicking outside
        setTimeout(() => {
            document.addEventListener('click', function closeDropdown(e) {
                if (!button.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }, 0);
    }
}

// Custom modal functionality
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('show');
    document.body.style.overflow = '';
}

// Close modal when clicking on backdrop
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal(modal.id);
        }
    });
});

function openBillForm() {
    // Redirect to bill form in same tab
    const url = '{% url "purchase:bill_add" %}';
    window.location.href = url;
}

function editBill(billId) {
    // Redirect to bill edit form in same tab
    const url = `/purchase/bills/${billId}/edit/`;
    window.location.href = url;
}

function approveBill(billId) {
    showModal('approveModal');
    
    document.getElementById('confirmApprove').onclick = function() {
        $.ajax({
            url: `/purchase/bills/${billId}/approve/`,
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                closeModal('approveModal');
                if (response.success) {
                    location.reload();
                } else {
                    alert('Error approving bill: ' + response.message);
                }
            },
            error: function() {
                closeModal('approveModal');
                alert('Error approving bill. Please try again.');
            }
        });
    };
}

function deleteBill(billId) {
    showModal('deleteModal');
    
    document.getElementById('confirmDelete').onclick = function() {
        $.ajax({
            url: `/purchase/bills/${billId}/delete/`,
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                closeModal('deleteModal');
                if (response.success) {
                    location.reload();
                } else {
                    alert('Error deleting bill: ' + response.message);
                }
            },
            error: function() {
                closeModal('deleteModal');
                alert('Error deleting bill. Please try again.');
            }
        });
    };
}

function createPayment(billId) {
    // Redirect to payment form in same tab
    const url = `/purchase/bills/${billId}/payment/`;
    window.location.href = url;
}

// Auto-refresh page every 5 minutes to show updated bill statuses
setInterval(function() {
    // Only refresh if no modals are open
    if (!document.querySelector('.modal.show')) {
        location.reload();
    }
}, 300000); // 5 minutes
</script>
{% endblock %}
