{% extends 'base.html' %}
{% load static %}

{% block title %}Bill {{ bill.bill_number }} - Details{% endblock %}

{% block extra_css %}
<style>
    .bill-detail-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .bill-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px 15px 0 0;
        margin-bottom: 0;
    }
    
    .bill-content {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 0 0 15px 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .section {
        padding: 25px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .section:last-child {
        border-bottom: none;
    }
    
    .section-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .info-item {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #007bff;
    }
    
    .info-label {
        font-weight: 600;
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    
    .info-value {
        font-size: 1.1rem;
        color: #495057;
    }
    
    .status-badge {
        padding: 8px 16px;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        display: inline-block;
    }
    
    .status-draft {
        background-color: #f8f9fa;
        color: #6c757d;
    }
    
    .status-submitted {
        background-color: #cff4fc;
        color: #055160;
    }
    
    .status-approved {
        background-color: #d1e7dd;
        color: #0a3622;
    }
    
    .status-paid {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-partially-paid {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-overdue {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .matching-info {
        background-color: #e7f3ff;
        border: 1px solid #b6d7ff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .matching-success {
        background-color: #d4edda;
        border-color: #c3e6cb;
    }
    
    .matching-warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
    }
    
    .matching-error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }
    
    .items-table {
        margin-top: 20px;
    }
    
    .items-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        border-top: none;
    }
    
    .tracking-info {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 10px;
        margin-top: 10px;
        font-size: 0.9rem;
    }
    
    .variance-indicator {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8rem;
        margin-left: 5px;
    }
    
    .variance-positive {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .variance-negative {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .totals-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding: 5px 0;
    }
    
    .total-row.grand-total {
        border-top: 2px solid #495057;
        padding-top: 15px;
        margin-top: 15px;
        font-weight: bold;
        font-size: 1.3rem;
    }
    
    .payments-table {
        margin-top: 20px;
    }
    
    .document-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .document-item {
        text-align: center;
        padding: 20px;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .document-item:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }
    
    .document-item.has-file {
        border-color: #28a745;
        background-color: #f8fff9;
    }
    
    .document-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        color: #6c757d;
    }
    
    .document-item.has-file .document-icon {
        color: #28a745;
    }
    
    .action-buttons {
        padding: 25px;
        background-color: #f8f9fa;
        border-radius: 0 0 15px 15px;
        text-align: center;
    }
    
    .btn {
        margin: 0 5px;
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 600;
    }
    
    .alert {
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .related-docs {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    
    .related-doc-link {
        display: inline-block;
        padding: 8px 15px;
        background-color: #e9ecef;
        border-radius: 6px;
        text-decoration: none;
        color: #495057;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }
    
    .related-doc-link:hover {
        background-color: #007bff;
        color: white;
        text-decoration: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="bill-detail-container">
    <!-- Header -->
    <div class="bill-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1><i class="fas fa-file-invoice-dollar"></i> Bill {{ bill.bill_number }}</h1>
                <p class="mb-0">Purchase invoice from {{ bill.supplier.name }}</p>
            </div>
            <div class="col-md-4 text-right">
                <span class="status-badge status-{{ bill.status }}">
                    {{ bill.get_status_display }}
                </span>
            </div>
        </div>
    </div>
    
    <div class="bill-content">
        <!-- Basic Information -->
        <div class="section">
            <div class="section-title">
                <i class="fas fa-info-circle"></i> Basic Information
            </div>
            
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Supplier</div>
                    <div class="info-value">{{ bill.supplier.name }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Supplier Invoice Number</div>
                    <div class="info-value">{{ bill.supplier_invoice_number|default:"-" }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Bill Date</div>
                    <div class="info-value">{{ bill.bill_date|date:"F d, Y" }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Due Date</div>
                    <div class="info-value">
                        {{ bill.due_date|date:"F d, Y" }}
                        {% if bill.is_overdue %}
                            <span class="variance-indicator variance-negative">Overdue</span>
                        {% endif %}
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Created By</div>
                    <div class="info-value">{{ bill.created_by.get_full_name|default:bill.created_by.email }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Created Date</div>
                    <div class="info-value">{{ bill.created_at|date:"F d, Y g:i A" }}</div>
                </div>
            </div>
            
            {% if bill.notes %}
                <div class="info-item">
                    <div class="info-label">Notes</div>
                    <div class="info-value">{{ bill.notes }}</div>
                </div>
            {% endif %}
        </div>
        
        <!-- Matching Information -->
        {% if bill.matching_type and bill.matching_type != 'standalone' %}
            <div class="section">
                <div class="section-title">
                    <i class="fas fa-link"></i> Document Matching
                </div>
                
                <div class="matching-info {% if bill.three_way_match_status %}matching-success{% else %}matching-warning{% endif %}">
                    <h6>
                        <i class="fas fa-{% if bill.three_way_match_status %}check-circle{% else %}clock{% endif %}"></i>
                        {{ bill.get_matching_type_display }} Matching
                    </h6>
                    <p class="mb-2">
                        {% if bill.three_way_match_status %}
                            All documents have been successfully matched and validated.
                        {% else %}
                            Document matching is pending validation.
                        {% endif %}
                    </p>
                    
                    <div class="related-docs">
                        {% if bill.purchase_order %}
                            <a href="{% url 'purchase:purchase_order_detail' bill.purchase_order.pk %}" target="_blank" class="related-doc-link">
                                <i class="fas fa-shopping-cart"></i> PO {{ bill.purchase_order.po_number }}
                            </a>
                        {% endif %}
                        {% if bill.grn %}
                            <a href="{% url 'purchase:grn_detail' bill.grn.pk %}" target="_blank" class="related-doc-link">
                                <i class="fas fa-truck"></i> GRN {{ bill.grn.grn_number }}
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- Items -->
        <div class="section">
            <div class="section-title">
                <i class="fas fa-list"></i> Bill Items
            </div>
            
            {% if items %}
                <div class="table-responsive items-table">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Line Total</th>
                                <th>Source</th>
                                <th>Variance</th>
                                <th>Tracking</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                                <tr>
                                    <td>
                                        <strong>{{ item.product.name }}</strong>
                                        <br><small class="text-muted">{{ item.product.sku }}</small>
                                        {% if item.notes %}
                                            <br><small class="text-info">{{ item.notes }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ item.quantity }}</td>
                                    <td>${{ item.unit_price|floatformat:2 }}</td>
                                    <td><strong>${{ item.line_total|floatformat:2 }}</strong></td>
                                    <td>
                                        <span class="badge badge-info">{{ item.get_item_source_display }}</span>
                                        {% if item.po_item %}
                                            <br><small class="text-muted">PO Item</small>
                                        {% endif %}
                                        {% if item.grn_item %}
                                            <br><small class="text-muted">GRN Item</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.po_quantity_variance != 0 %}
                                            <span class="variance-indicator {% if item.po_quantity_variance > 0 %}variance-positive{% else %}variance-negative{% endif %}">
                                                PO: {{ item.po_quantity_variance|floatformat:0 }}
                                            </span>
                                        {% endif %}
                                        {% if item.grn_quantity_variance != 0 %}
                                            <span class="variance-indicator {% if item.grn_quantity_variance > 0 %}variance-positive{% else %}variance-negative{% endif %}">
                                                GRN: {{ item.grn_quantity_variance|floatformat:0 }}
                                            </span>
                                        {% endif %}
                                        {% if item.po_quantity_variance == 0 and item.grn_quantity_variance == 0 %}
                                            <span class="text-success"><i class="fas fa-check"></i> Perfect</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.tracking_required %}
                                            <span class="badge badge-warning">
                                                {{ item.tracking_items.count }} / {{ item.quantity|floatformat:0 }}
                                            </span>
                                            {% if item.tracking_items.count > 0 %}
                                                <div class="tracking-info">
                                                    {% for tracking in item.tracking_items.all %}
                                                        <small>{{ tracking.tracking_type }}: {{ tracking.tracking_number }}</small><br>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">Not Required</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    No items found for this bill.
                </div>
            {% endif %}
        </div>
        
        <!-- Totals -->
        <div class="section">
            <div class="section-title">
                <i class="fas fa-calculator"></i> Amount Summary
            </div>
            
            <div class="totals-section">
                <div class="total-row">
                    <span>Subtotal:</span>
                    <span>${{ bill.subtotal|floatformat:2 }}</span>
                </div>
                <div class="total-row">
                    <span>Tax Amount:</span>
                    <span>${{ bill.tax_amount|floatformat:2 }}</span>
                </div>
                <div class="total-row">
                    <span>Discount:</span>
                    <span>${{ bill.discount_amount|floatformat:2 }}</span>
                </div>
                <div class="total-row grand-total">
                    <span>Total Amount:</span>
                    <span>${{ bill.total_amount|floatformat:2 }}</span>
                </div>
                <div class="total-row">
                    <span>Paid Amount:</span>
                    <span class="text-success">${{ bill.paid_amount|floatformat:2 }}</span>
                </div>
                <div class="total-row">
                    <span>Outstanding Amount:</span>
                    <span class="{% if bill.outstanding_amount > 0 %}text-danger{% else %}text-success{% endif %}">
                        ${{ bill.outstanding_amount|floatformat:2 }}
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Payments -->
        {% if payments %}
            <div class="section">
                <div class="section-title">
                    <i class="fas fa-credit-card"></i> Payment History
                </div>
                
                <div class="table-responsive payments-table">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Payment Date</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Reference</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payments %}
                                <tr>
                                    <td>{{ payment.payment_date|date:"M d, Y" }}</td>
                                    <td>${{ payment.amount|floatformat:2 }}</td>
                                    <td>{{ payment.get_payment_method_display }}</td>
                                    <td>{{ payment.reference_number|default:"-" }}</td>
                                    <td>
                                        <span class="badge badge-{{ payment.status }}">
                                            {{ payment.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <a href="#" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}
        
        <!-- Documents -->
        <div class="section">
            <div class="section-title">
                <i class="fas fa-paperclip"></i> Attached Documents
            </div>
            
            <div class="document-section">
                <div class="document-item {% if bill.supplier_invoice %}has-file{% endif %}">
                    <div class="document-icon">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <h6>Supplier Invoice</h6>
                    {% if bill.supplier_invoice %}
                        <a href="{{ bill.supplier_invoice.url }}" target="_blank" class="btn btn-sm btn-success">
                            <i class="fas fa-download"></i> Download
                        </a>
                    {% else %}
                        <p class="text-muted">Not uploaded</p>
                    {% endif %}
                </div>
                
                <div class="document-item {% if bill.tax_invoice %}has-file{% endif %}">
                    <div class="document-icon">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <h6>Tax Invoice</h6>
                    {% if bill.tax_invoice %}
                        <a href="{{ bill.tax_invoice.url }}" target="_blank" class="btn btn-sm btn-success">
                            <i class="fas fa-download"></i> Download
                        </a>
                    {% else %}
                        <p class="text-muted">Not uploaded</p>
                    {% endif %}
                </div>
                
                <div class="document-item {% if bill.supporting_documents %}has-file{% endif %}">
                    <div class="document-icon">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <h6>Supporting Docs</h6>
                    {% if bill.supporting_documents %}
                        <a href="{{ bill.supporting_documents.url }}" target="_blank" class="btn btn-sm btn-success">
                            <i class="fas fa-download"></i> Download
                        </a>
                    {% else %}
                        <p class="text-muted">Not uploaded</p>
                    {% endif %}
                </div>
                
                <div class="document-item {% if bill.approval_documents %}has-file{% endif %}">
                    <div class="document-icon">
                        <i class="fas fa-stamp"></i>
                    </div>
                    <h6>Approval Docs</h6>
                    {% if bill.approval_documents %}
                        <a href="{{ bill.approval_documents.url }}" target="_blank" class="btn btn-sm btn-success">
                            <i class="fas fa-download"></i> Download
                        </a>
                    {% else %}
                        <p class="text-muted">Not uploaded</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="action-buttons">
        {% if bill.status == 'draft' %}
            <a href="javascript:void(0)" onclick="editBill({{ bill.pk }})" class="btn btn-warning">
                <i class="fas fa-edit"></i> Edit Bill
            </a>
        {% endif %}
        
        {% if can_approve and bill.status == 'submitted' %}
            <button type="button" onclick="approveBill({{ bill.pk }})" class="btn btn-success">
                <i class="fas fa-check"></i> Approve Bill
            </button>
        {% endif %}
        
        {% if bill.outstanding_amount > 0 and bill.status == 'approved' %}
            <a href="javascript:void(0)" onclick="createPayment({{ bill.pk }})" class="btn btn-info">
                <i class="fas fa-dollar-sign"></i> Record Payment
            </a>
        {% endif %}
        
        <a href="#" onclick="window.print()" class="btn btn-secondary">
            <i class="fas fa-print"></i> Print
        </a>
        
        <a href="{% url 'purchase:bills_ui' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Bills
        </a>
        
        {% if bill.status == 'draft' %}
            <button type="button" onclick="deleteBill({{ bill.pk }})" class="btn btn-outline-danger">
                <i class="fas fa-trash"></i> Delete
            </button>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function editBill(billId) {
    const url = `/purchase/bills/${billId}/edit/`;
    window.location.href = url;
}

function approveBill(billId) {
    if (confirm('Are you sure you want to approve this bill? This action cannot be undone.')) {
        $.ajax({
            url: `/purchase/bills/${billId}/approve/`,
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('Error approving bill: ' + response.message);
                }
            },
            error: function() {
                alert('Error approving bill. Please try again.');
            }
        });
    }
}

function createPayment(billId) {
    const url = `/purchase/bills/${billId}/payment/`;
    window.location.href = url;
}

function deleteBill(billId) {
    if (confirm('Are you sure you want to delete this bill? This action cannot be undone.')) {
        $.ajax({
            url: `/purchase/bills/${billId}/delete/`,
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    window.location.href = '{% url "purchase:bills_ui" %}';
                } else {
                    alert('Error deleting bill: ' + response.message);
                }
            },
            error: function() {
                alert('Error deleting bill. Please try again.');
            }
        });
    }
}

// Print styles
window.addEventListener('beforeprint', function() {
    document.body.classList.add('printing');
});

window.addEventListener('afterprint', function() {
    document.body.classList.remove('printing');
});
</script>

<style media="print">
    .action-buttons,
    .btn,
    .navbar,
    .sidebar {
        display: none !important;
    }
    
    .bill-detail-container {
        max-width: none;
        margin: 0;
        padding: 0;
    }
    
    .bill-header {
        background: #333 !important;
        -webkit-print-color-adjust: exact;
    }
    
    .section {
        page-break-inside: avoid;
    }
    
    .items-table {
        page-break-inside: avoid;
    }
    
    .totals-section {
        page-break-inside: avoid;
    }
</style>
{% endblock %}
