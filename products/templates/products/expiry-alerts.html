{% extends 'base.html' %}
{% load static %}

{% block title %}Product Expiry Alerts - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .alert-card {
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .expired-card {
        border-left: 5px solid #dc3545;
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    }
    
    .expiring-critical-card {
        border-left: 5px solid #fd7e14;
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    }
    
    .expiring-soon-card {
        border-left: 5px solid #ffc107;
        background: linear-gradient(135deg, #fff3cd 0%, #ffe0a3 100%);
    }
    
    .stats-overview {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .stat-item {
        text-align: center;
        padding: 15px;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .tracking-item {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        transition: box-shadow 0.3s ease;
    }
    
    .tracking-item:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .tracking-number {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        color: #495057;
    }
    
    .expiry-badge {
        font-size: 0.8rem;
        padding: 0.3rem 0.6rem;
        border-radius: 0.3rem;
        font-weight: 600;
    }
    
    .expired {
        background-color: #dc3545;
        color: white;
    }
    
    .expiring-critical {
        background-color: #fd7e14;
        color: white;
    }
    
    .expiring-soon {
        background-color: #ffc107;
        color: #212529;
    }
    
    .days-remaining {
        font-weight: bold;
    }
    
    .days-remaining.negative {
        color: #dc3545;
    }
    
    .days-remaining.critical {
        color: #fd7e14;
    }
    
    .days-remaining.warning {
        color: #ffc107;
    }
    
    .product-image {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
        margin-right: 15px;
    }
    
    .product-info {
        display: flex;
        align-items: center;
    }
    
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    
    .priority-high {
        border-left-color: #dc3545 !important;
        border-left-width: 4px !important;
    }
    
    .priority-medium {
        border-left-color: #fd7e14 !important;
        border-left-width: 4px !important;
    }
    
    .priority-low {
        border-left-color: #ffc107 !important;
        border-left-width: 4px !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-exclamation-triangle mr-2"></i>Product Expiry Alerts</h2>
                <div class="btn-group">
                    <a href="{% url 'products:tracking_dashboard' %}" class="btn btn-outline-primary">
                        <i class="fas fa-chart-line mr-1"></i>Dashboard
                    </a>
                    <a href="{% url 'products:tracking_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-list mr-1"></i>All Tracking Units
                    </a>
                    <button class="btn btn-outline-success" onclick="exportExpiryReport()">
                        <i class="fas fa-download mr-1"></i>Export Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Overview -->
    <div class="row">
        <div class="col-12">
            <div class="stats-overview">
                <div class="row">
                    <div class="col-md-3 stat-item">
                        <div class="stat-number">{{ expired_items.count }}</div>
                        <div class="stat-label">Expired Items</div>
                    </div>
                    <div class="col-md-3 stat-item">
                        <div class="stat-number">{{ expiring_critical.count }}</div>
                        <div class="stat-label">Expiring in 7 Days</div>
                    </div>
                    <div class="col-md-3 stat-item">
                        <div class="stat-number">{{ expiring_soon.count }}</div>
                        <div class="stat-label">Expiring in 30 Days</div>
                    </div>
                    <div class="col-md-3 stat-item">
                        <div class="stat-number">{{ expired_items.count|add:expiring_critical.count|add:expiring_soon.count }}</div>
                        <div class="stat-label">Total Alerts</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Expired Items -->
    {% if expired_items %}
    <div class="row">
        <div class="col-12">
            <div class="alert-card expired-card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-times-circle mr-2"></i>Expired Items ({{ expired_items.count }})
                        <span class="badge badge-light ml-2">{{ expired_items.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% for item in expired_items %}
                    <div class="tracking-item priority-high">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="product-info">
                                    {% if item.product.image %}
                                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="product-image">
                                    {% else %}
                                        <div class="product-image bg-light d-flex align-items-center justify-content-center">
                                            <i class="fas fa-box text-muted"></i>
                                        </div>
                                    {% endif %}
                                    <div>
                                        <h6 class="mb-0">{{ item.product.name }}</h6>
                                        <small class="text-muted">{{ item.product.sku }}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <span class="tracking-number">{{ item.get_tracking_value }}</span>
                            </div>
                            <div class="col-md-2">
                                <span class="expiry-badge expired">
                                    {{ item.expiry_date|date:"M j, Y" }}
                                </span>
                            </div>
                            <div class="col-md-2">
                                {% with days_expired=item.expiry_date|timesince|split:" "|first %}
                                <span class="days-remaining negative">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                    Expired {{ days_expired }} ago
                                </span>
                                {% endwith %}
                            </div>
                            <div class="col-md-2">
                                <div class="action-buttons">
                                    <a href="{% url 'products:tracking_detail' item.pk %}" class="btn btn-sm btn-outline-primary" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-danger" onclick="quarantineItem({{ item.pk }})" title="Quarantine">
                                        <i class="fas fa-shield-alt"></i>
                                    </button>
                                    <a href="{% url 'products:tracking_edit' item.pk %}" class="btn btn-sm btn-outline-secondary" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Critical Expiring Items (7 days) -->
    {% if expiring_critical %}
    <div class="row">
        <div class="col-12">
            <div class="alert-card expiring-critical-card">
                <div class="card-header" style="background-color: #fd7e14; color: white;">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation mr-2"></i>Expiring Within 7 Days ({{ expiring_critical.count }})
                        <span class="badge badge-light ml-2">{{ expiring_critical.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% for item in expiring_critical %}
                    <div class="tracking-item priority-medium">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="product-info">
                                    {% if item.product.image %}
                                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="product-image">
                                    {% else %}
                                        <div class="product-image bg-light d-flex align-items-center justify-content-center">
                                            <i class="fas fa-box text-muted"></i>
                                        </div>
                                    {% endif %}
                                    <div>
                                        <h6 class="mb-0">{{ item.product.name }}</h6>
                                        <small class="text-muted">{{ item.product.sku }}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <span class="tracking-number">{{ item.get_tracking_value }}</span>
                            </div>
                            <div class="col-md-2">
                                <span class="expiry-badge expiring-critical">
                                    {{ item.expiry_date|date:"M j, Y" }}
                                </span>
                            </div>
                            <div class="col-md-2">
                                {% with days_remaining=item.expiry_date|timeuntil|split:" "|first %}
                                <span class="days-remaining critical">
                                    <i class="fas fa-clock mr-1"></i>
                                    {{ days_remaining }} days left
                                </span>
                                {% endwith %}
                            </div>
                            <div class="col-md-2">
                                <div class="action-buttons">
                                    <a href="{% url 'products:tracking_detail' item.pk %}" class="btn btn-sm btn-outline-primary" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-warning" onclick="reserveItem({{ item.pk }})" title="Reserve">
                                        <i class="fas fa-lock"></i>
                                    </button>
                                    <a href="{% url 'products:tracking_edit' item.pk %}" class="btn btn-sm btn-outline-secondary" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Expiring Soon Items (30 days) -->
    {% if expiring_soon %}
    <div class="row">
        <div class="col-12">
            <div class="alert-card expiring-soon-card">
                <div class="card-header" style="background-color: #ffc107; color: #212529;">
                    <h5 class="mb-0">
                        <i class="fas fa-clock mr-2"></i>Expiring Within 30 Days ({{ expiring_soon.count }})
                        <span class="badge badge-dark ml-2">{{ expiring_soon.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% for item in expiring_soon %}
                    <div class="tracking-item priority-low">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="product-info">
                                    {% if item.product.image %}
                                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="product-image">
                                    {% else %}
                                        <div class="product-image bg-light d-flex align-items-center justify-content-center">
                                            <i class="fas fa-box text-muted"></i>
                                        </div>
                                    {% endif %}
                                    <div>
                                        <h6 class="mb-0">{{ item.product.name }}</h6>
                                        <small class="text-muted">{{ item.product.sku }}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <span class="tracking-number">{{ item.get_tracking_value }}</span>
                            </div>
                            <div class="col-md-2">
                                <span class="expiry-badge expiring-soon">
                                    {{ item.expiry_date|date:"M j, Y" }}
                                </span>
                            </div>
                            <div class="col-md-2">
                                {% with days_remaining=item.expiry_date|timeuntil|split:" "|first %}
                                <span class="days-remaining warning">
                                    <i class="fas fa-calendar mr-1"></i>
                                    {{ days_remaining }} days left
                                </span>
                                {% endwith %}
                            </div>
                            <div class="col-md-2">
                                <div class="action-buttons">
                                    <a href="{% url 'products:tracking_detail' item.pk %}" class="btn btn-sm btn-outline-primary" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-info" onclick="notifyCustomer({{ item.pk }})" title="Notify Customer">
                                        <i class="fas fa-bell"></i>
                                    </button>
                                    <a href="{% url 'products:tracking_edit' item.pk %}" class="btn btn-sm btn-outline-secondary" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- No Alerts -->
    {% if not expired_items and not expiring_critical and not expiring_soon %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <h4 class="text-success">No Expiry Alerts</h4>
                    <p class="text-muted">All tracked items are within their expiry dates. Great job!</p>
                    <a href="{% url 'products:tracking_list' %}" class="btn btn-primary">
                        <i class="fas fa-list mr-1"></i>View All Tracking Units
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function quarantineItem(trackingId) {
    if (confirm('Are you sure you want to quarantine this expired item?')) {
        updateItemStatus(trackingId, 'quarantine');
    }
}

function reserveItem(trackingId) {
    if (confirm('Are you sure you want to reserve this item for immediate use?')) {
        updateItemStatus(trackingId, 'reserved');
    }
}

function notifyCustomer(trackingId) {
    if (confirm('Send expiry notification to customer for this item?')) {
        // Implementation for customer notification
        fetch(`{% url 'products:tracking_detail' 0 %}`.replace('0', trackingId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'notify_customer'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Customer notification sent successfully');
            } else {
                alert('Error sending notification: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
}

function updateItemStatus(trackingId, newStatus) {
    fetch(`{% url 'products:tracking_detail' 0 %}`.replace('0', trackingId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'update_status',
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating status: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function exportExpiryReport() {
    // Create CSV export
    const csvData = [];
    csvData.push(['Product Name', 'SKU', 'Tracking Number', 'Expiry Date', 'Days Remaining', 'Status', 'Warehouse']);
    
    // Add expired items
    {% for item in expired_items %}
    csvData.push([
        '{{ item.product.name|escapejs }}',
        '{{ item.product.sku|escapejs }}',
        '{{ item.get_tracking_value|escapejs }}',
        '{{ item.expiry_date|date:"Y-m-d" }}',
        'Expired',
        'Expired',
        '{{ item.current_warehouse.name|default:"Not assigned"|escapejs }}'
    ]);
    {% endfor %}
    
    // Add critical items
    {% for item in expiring_critical %}
    csvData.push([
        '{{ item.product.name|escapejs }}',
        '{{ item.product.sku|escapejs }}',
        '{{ item.get_tracking_value|escapejs }}',
        '{{ item.expiry_date|date:"Y-m-d" }}',
        'Critical (7 days)',
        'Expiring Soon',
        '{{ item.current_warehouse.name|default:"Not assigned"|escapejs }}'
    ]);
    {% endfor %}
    
    // Add warning items
    {% for item in expiring_soon %}
    csvData.push([
        '{{ item.product.name|escapejs }}',
        '{{ item.product.sku|escapejs }}',
        '{{ item.get_tracking_value|escapejs }}',
        '{{ item.expiry_date|date:"Y-m-d" }}',
        'Warning (30 days)',
        'Expiring Soon',
        '{{ item.current_warehouse.name|default:"Not assigned"|escapejs }}'
    ]);
    {% endfor %}
    
    // Convert to CSV string
    const csvString = csvData.map(row => row.map(field => `"${field}"`).join(',')).join('\n');
    
    // Create download link
    const blob = new Blob([csvString], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `expiry_alerts_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
}

// Auto-refresh page every 5 minutes
setTimeout(function() {
    location.reload();
}, 300000);
</script>
{% endblock %}
