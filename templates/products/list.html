{% extends 'base.html' %}
{% load static %}

{% block title %}All Products | FutureERP{% endblock %}

{% block extra_css %}
<style>
    .product-card {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 95, 70, 0.1));
        border: 1px solid rgba(16, 185, 129, 0.2);
        transition: all 0.3s ease;
    }
    .product-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.15);
    }
    .status-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    .status-active { background-color: #d1fae5; color: #059669; }
    .status-inactive { background-color: #fee2e2; color: #dc2626; }
    .flag-badge {
        padding: 1px 6px;
        border-radius: 8px;
        font-size: 0.7rem;
        font-weight: 500;
        margin-right: 2px;
    }
    .flag-saleable { background-color: #dcfce7; color: #15803d; }
    .flag-purchasable { background-color: #dbeafe; color: #1d4ed8; }
    .flag-manufacturable { background-color: #fef3c7; color: #d97706; }
    .flag-stockable { background-color: #f0f9ff; color: #0284c7; }
    .flag-variant { background-color: #f3f4f6; color: #374151; }
</style>
{% endblock %}

{% block content %}
<div class="pt-24 pb-8">
    <div class="mx-auto px-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-bold accounting-highlight mb-2">All Products</h1>
                <p class="text-gray-600">Manage your product catalog and inventory</p>
            </div>
            <div class="flex gap-4">
                <a href="{% url 'products:create' %}" class="action-btn bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-2xl hover-lift">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Add Product
                </a>
                <a href="{% url 'products:dashboard' %}" class="action-btn bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-2xl hover-lift">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Dashboard
                </a>
            </div>
        </div>

        <!-- Filters -->
        <div class="card-modern mb-8">
            <form method="GET" class="flex flex-wrap gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                    <input type="text" name="search" value="{{ search_query }}" placeholder="Search name, SKU, description..." 
                           class="form-input rounded-lg border-gray-300">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <select name="category" class="form-select rounded-lg border-gray-300">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if selected_category == category.id|stringformat:"s" %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                    <select name="type" class="form-select rounded-lg border-gray-300">
                        <option value="">All Types</option>
                        {% for value, label in product_types %}
                        <option value="{{ value }}" {% if selected_type == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select name="status" class="form-select rounded-lg border-gray-300">
                        <option value="">All Status</option>
                        <option value="active" {% if selected_status == 'active' %}selected{% endif %}>Active</option>
                        <option value="inactive" {% if selected_status == 'inactive' %}selected{% endif %}>Inactive</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Filter</button>
                <a href="{% url 'products:list' %}" class="btn-secondary">Clear</a>
            </form>
        </div>

        <!-- Products List -->
        <div class="grid grid-cols-1 gap-6">
            {% for product in products %}
            <div class="product-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900">{{ product.name }}</h3>
                            <p class="text-gray-600">SKU: <code>{{ product.sku }}</code> â€¢ {{ product.get_product_type_display }}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="status-badge status-{{ product.is_active|yesno:'active,inactive' }}">
                            {{ product.is_active|yesno:'Active,Inactive' }}
                        </span>
                        <div class="flex gap-2">
                            <a href="{% url 'products:detail' product.id %}" class="btn-sm btn-primary">View</a>
                            <a href="{% url 'products:update' product.id %}" class="btn-sm btn-secondary">Edit</a>
                            <button type="button" class="btn-sm btn-warning toggle-active" 
                                    data-product-id="{{ product.id }}" 
                                    data-current-status="{{ product.is_active|yesno:'true,false' }}"
                                    title="Toggle Active">
                                Toggle
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
                    <div>
                        <p class="text-sm text-gray-500">Category</p>
                        <p class="font-medium">{{ product.category.name|default:"No Category" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Tracking Method</p>
                        <p class="font-medium">{{ product.get_tracking_method_display }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Cost Price</p>
                        <p class="font-medium">${{ product.cost_price|floatformat:2 }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Selling Price</p>
                        <p class="font-medium font-bold text-green-600">${{ product.selling_price|floatformat:2 }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Flags</p>
                        <div>
                            {% if product.is_saleable %}<span class="flag-badge flag-saleable">S</span>{% endif %}
                            {% if product.is_purchasable %}<span class="flag-badge flag-purchasable">P</span>{% endif %}
                            {% if product.is_manufacturable %}<span class="flag-badge flag-manufacturable">M</span>{% endif %}
                            {% if product.is_stockable %}<span class="flag-badge flag-stockable">St</span>{% endif %}
                            {% if product.is_variant %}<span class="flag-badge flag-variant">V</span>{% endif %}
                        </div>
                    </div>
                </div>
                
                {% if product.description %}
                <div class="border-t pt-4">
                    <p class="text-sm text-gray-500 mb-1">Description</p>
                    <p class="text-gray-700">{{ product.description|truncatewords:20 }}</p>
                </div>
                {% endif %}
            </div>
            {% empty %}
            <div class="text-center py-12">
                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                </svg>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
                <p class="text-gray-500 mb-4">Start by creating your first product</p>
                <a href="{% url 'products:create' %}" class="btn-primary">Create Product</a>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <div class="mt-8 flex justify-center">
            <nav class="flex space-x-2">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                       class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50">Previous</a>
                {% endif %}
                
                <span class="px-3 py-2 text-sm bg-green-600 text-white rounded-md">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                </span>
                
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                       class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50">Next</a>
                {% endif %}
            </nav>
        </div>
        {% endif %}

        <!-- Bulk Actions Section -->
        <div class="mt-6 p-4 bg-gray-50 rounded-lg">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="select-all" class="form-check-input mr-2">
                        Select All
                    </label>
                    <span id="selected-count">0</span> products selected
                </div>
                <div>
                    <button type="button" class="btn-sm btn-warning" id="bulk-toggle-active" disabled>
                        Toggle Active Status
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add individual checkboxes to each product card
    document.querySelectorAll('.product-card').forEach(card => {
        const productId = card.querySelector('[data-product-id]')?.dataset.productId;
        if (productId) {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'product-checkbox';
            checkbox.value = productId;
            checkbox.style.position = 'absolute';
            checkbox.style.top = '10px';
            checkbox.style.right = '10px';
            card.style.position = 'relative';
            card.appendChild(checkbox);
        }
    });

    // Select all functionality
    const selectAllCheckbox = document.getElementById('select-all');
    const productCheckboxes = document.querySelectorAll('.product-checkbox');
    const selectedCountSpan = document.getElementById('selected-count');
    const bulkToggleBtn = document.getElementById('bulk-toggle-active');

    selectAllCheckbox.addEventListener('change', function() {
        productCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectedCount();
    });

    productCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });

    function updateSelectedCount() {
        const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
        const count = selectedCheckboxes.length;
        selectedCountSpan.textContent = count;
        bulkToggleBtn.disabled = count === 0;
        
        selectAllCheckbox.checked = count === productCheckboxes.length;
        selectAllCheckbox.indeterminate = count > 0 && count < productCheckboxes.length;
    }

    // Toggle active status
    document.querySelectorAll('.toggle-active').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;
            
            fetch(`/products/${productId}/toggle-active/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        });
    });

    // Bulk toggle active
    bulkToggleBtn.addEventListener('click', function() {
        const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
        const productIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        
        if (confirm(`Toggle active status for ${productIds.length} products?`)) {
            const formData = new FormData();
            productIds.forEach(id => formData.append('product_ids', id));
            
            fetch('/products/bulk-toggle-active/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        }
    });
});
</script>

<style>
.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    border-radius: 0.375rem;
}
.btn-primary { background-color: #10b981; color: white; border: none; }
.btn-secondary { background-color: #6b7280; color: white; border: none; }
.btn-warning { background-color: #f59e0b; color: white; border: none; }
</style>
{% endblock %}
