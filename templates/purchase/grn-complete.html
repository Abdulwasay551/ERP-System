{% extends 'base.html' %}
{% load static %}

{% block title %}Complete GRN - {{ grn.grn_number }}{% endblock %}

{% block extra_css %}
<style>
    .grn-complete-card {
        background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
        border: 1px solid #bbf7d0;
        transition: all 0.3s ease;
    }

    .item-card {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        transition: all 0.3s ease;
    }

    .item-card:hover {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }

    .status-received { background-color: #10b981; }
    .status-partial { background-color: #f59e0b; }
    .status-damaged { background-color: #ef4444; }
    .status-pending { background-color: #6b7280; }

    .quantity-input {
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        transition: border-color 0.3s ease;
    }

    .quantity-input:focus {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .tracking-section {
        background: #f8fafc;
        border: 1px dashed #cbd5e1;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-top: 1rem;
    }

    .action-btn {
        transition: all 0.3s ease;
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="grn-complete-card rounded-2xl p-6 mb-8">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Complete GRN</h1>
                    <div class="flex items-center gap-4 text-sm text-gray-600">
                        <span><strong>GRN Number:</strong> {{ grn.grn_number }}</span>
                        <span><strong>Purchase Order:</strong> {{ grn.purchase_order.po_number }}</span>
                        <span><strong>Supplier:</strong> {{ grn.purchase_order.supplier.name }}</span>
                        <span><strong>Expected Date:</strong> {{ grn.expected_date|date:"M d, Y" }}</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                        <span class="status-indicator status-pending"></span>
                        {{ grn.get_status_display }}
                    </span>
                </div>
            </div>
        </div>

        <form id="grnCompleteForm" method="post">
            {% csrf_token %}
            
            <!-- Items to Receive -->
            <div class="grid grid-cols-1 gap-6">
                {% for item in grn_items %}
                <div class="item-card p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900">{{ item.product.name }}</h3>
                            <p class="text-gray-600">SKU: {{ item.product.sku }}</p>
                            <div class="flex items-center gap-4 mt-2 text-sm text-gray-600">
                                <span><strong>Ordered:</strong> {{ item.ordered_quantity }} {{ item.unit_of_measure.abbreviation }}</span>
                                <span><strong>Unit Price:</strong> ${{ item.unit_price }}</span>
                                <span><strong>Total:</strong> ${{ item.line_total }}</span>
                            </div>
                        </div>
                        <div class="flex items-center">
                            {% if item.product.image %}
                            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" 
                                 class="w-16 h-16 object-cover rounded-lg">
                            {% else %}
                            <div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center">
                                <i class="fas fa-box text-gray-400"></i>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Quantity Received -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Quantity Received <span class="text-red-500">*</span>
                            </label>
                            <input type="number" 
                                   name="received_quantity_{{ item.id }}" 
                                   class="quantity-input w-full px-3 py-2" 
                                   value="{{ item.received_quantity|default:'0' }}"
                                   max="{{ item.ordered_quantity }}"
                                   min="0"
                                   step="0.01"
                                   required
                                   onchange="calculateItemTotal({{ item.id }})">
                        </div>

                        <!-- Condition -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Condition</label>
                            <select name="condition_{{ item.id }}" class="quantity-input w-full px-3 py-2">
                                <option value="good">Good</option>
                                <option value="damaged">Damaged</option>
                                <option value="defective">Defective</option>
                                <option value="expired">Expired</option>
                            </select>
                        </div>

                        <!-- Quality Status -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quality Status</label>
                            <select name="quality_status_{{ item.id }}" class="quantity-input w-full px-3 py-2">
                                <option value="pending">Pending Inspection</option>
                                <option value="passed">Quality Passed</option>
                                <option value="failed">Quality Failed</option>
                                <option value="quarantined">Quarantined</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tracking Information (for serialized products) -->
                    {% if item.product.tracking_method != 'none' %}
                    <div class="tracking-section">
                        <h4 class="font-semibold text-gray-900 mb-3">
                            <i class="fas fa-barcode mr-2"></i>
                            Tracking Information ({{ item.product.get_tracking_method_display }})
                        </h4>
                        <div id="tracking-container-{{ item.id }}">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        {% if item.product.tracking_method == 'serial' %}Serial Number
                                        {% elif item.product.tracking_method == 'batch' %}Batch Number
                                        {% elif item.product.tracking_method == 'imei' %}IMEI Number
                                        {% else %}Tracking ID{% endif %}
                                    </label>
                                    <input type="text" 
                                           name="tracking_{{ item.id }}[]"
                                           class="quantity-input w-full px-3 py-2"
                                           placeholder="Enter tracking information">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Manufacture Date</label>
                                    <input type="date" 
                                           name="manufacture_date_{{ item.id }}[]"
                                           class="quantity-input w-full px-3 py-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
                                    <input type="date" 
                                           name="expiry_date_{{ item.id }}[]"
                                           class="quantity-input w-full px-3 py-2">
                                </div>
                            </div>
                            <button type="button" 
                                    onclick="addTrackingRow({{ item.id }})"
                                    class="mt-3 text-green-600 hover:text-green-800 text-sm">
                                <i class="fas fa-plus mr-1"></i>Add Another
                            </button>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Notes -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                        <textarea name="notes_{{ item.id }}" 
                                  class="quantity-input w-full px-3 py-2" 
                                  rows="2"
                                  placeholder="Any notes about this item..."></textarea>
                    </div>

                    <!-- Item Summary -->
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Item Total:</span>
                            <span id="item-total-{{ item.id }}" class="font-semibold text-gray-900">
                                ${{ item.line_total }}
                            </span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- GRN Summary -->
            <div class="grn-complete-card rounded-2xl p-6 mt-8">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">GRN Summary</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Received Date</label>
                        <input type="date" 
                               name="received_date" 
                               class="quantity-input w-full px-3 py-2" 
                               value="{{ grn.received_date|date:'Y-m-d'|default:today }}"
                               required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Warehouse</label>
                        <select name="warehouse" class="quantity-input w-full px-3 py-2" required>
                            {% for warehouse in warehouses %}
                            <option value="{{ warehouse.id }}" 
                                    {% if warehouse.id == grn.warehouse.id %}selected{% endif %}>
                                {{ warehouse.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reference Document</label>
                        <input type="file" 
                               name="reference_document" 
                               class="quantity-input w-full px-3 py-2"
                               accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                    </div>
                </div>

                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">General Notes</label>
                    <textarea name="general_notes" 
                              class="quantity-input w-full px-3 py-2" 
                              rows="3"
                              placeholder="Any general notes about this receipt...">{{ grn.notes }}</textarea>
                </div>

                <!-- Total Summary -->
                <div class="mt-6 p-4 bg-green-50 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-semibold text-gray-900">Total GRN Value:</span>
                        <span id="grn-total" class="text-2xl font-bold text-green-600">
                            ${{ grn.total_amount|default:"0.00" }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end gap-4 mt-8">
                <a href="{% url 'purchase:grns_ui' %}" 
                   class="action-btn px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Cancel
                </a>
                <button type="button" 
                        onclick="saveDraft()"
                        class="action-btn px-6 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                    Save as Draft
                </button>
                <button type="submit" 
                        class="action-btn px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    Complete GRN
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function calculateItemTotal(itemId) {
    const quantityInput = document.querySelector(`input[name="received_quantity_${itemId}"]`);
    const quantity = parseFloat(quantityInput.value) || 0;
    
    // Get unit price from the form data or item data
    const unitPrice = parseFloat(quantityInput.getAttribute('data-unit-price')) || 0;
    const total = quantity * unitPrice;
    
    document.getElementById(`item-total-${itemId}`).textContent = `$${total.toFixed(2)}`;
    
    // Recalculate GRN total
    calculateGRNTotal();
}

function calculateGRNTotal() {
    let total = 0;
    document.querySelectorAll('[id^="item-total-"]').forEach(el => {
        const value = parseFloat(el.textContent.replace('$', '')) || 0;
        total += value;
    });
    
    document.getElementById('grn-total').textContent = `$${total.toFixed(2)}`;
}

function addTrackingRow(itemId) {
    const container = document.getElementById(`tracking-container-${itemId}`);
    const newRow = document.createElement('div');
    newRow.className = 'grid grid-cols-1 md:grid-cols-3 gap-4 mt-3';
    newRow.innerHTML = `
        <div>
            <input type="text" name="tracking_${itemId}[]" class="quantity-input w-full px-3 py-2" placeholder="Enter tracking information">
        </div>
        <div>
            <input type="date" name="manufacture_date_${itemId}[]" class="quantity-input w-full px-3 py-2">
        </div>
        <div>
            <input type="date" name="expiry_date_${itemId}[]" class="quantity-input w-full px-3 py-2">
        </div>
    `;
    container.appendChild(newRow);
}

function saveDraft() {
    const form = document.getElementById('grnCompleteForm');
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'action';
    hiddenInput.value = 'save_draft';
    form.appendChild(hiddenInput);
    form.submit();
}

// Initialize calculations on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set unit prices as data attributes
    {% for item in grn_items %}
    document.querySelector('input[name="received_quantity_{{ item.id }}"]').setAttribute('data-unit-price', '{{ item.unit_price }}');
    {% endfor %}
    
    calculateGRNTotal();
});
</script>
{% endblock %}
