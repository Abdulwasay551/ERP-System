{% extends 'base.html' %}
{% load static %}
{% block title %}Purchase Reports Dashboard{% endblock %}

{% block content %}
    <div class="container mx-auto p-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Purchase Analytics Dashboard</h1>
            <div class="flex space-x-2">
                <button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                    <i class="fas fa-download mr-2"></i>Export Report
                </button>
                <button class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm">
                    <i class="fas fa-filter mr-2"></i>Filter
                </button>
            </div>
        </div>

        <!-- Enhanced Summary Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg rounded-xl p-6 transform hover:scale-105 transition-transform">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium opacity-90">Total Purchase Orders</h3>
                        <p class="text-3xl font-bold">{{ total_purchase_orders }}</p>
                        <p class="text-xs opacity-75 mt-1">
                            <i class="fas fa-arrow-up mr-1"></i>+12% from last month
                        </p>
                    </div>
                    <div class="bg-white bg-opacity-20 text-black p-3 rounded-full">
                        <i class="fas fa-shopping-cart text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg rounded-xl p-6 transform hover:scale-105 transition-transform">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium opacity-90">Goods Received</h3>
                        <p class="text-3xl font-bold">{{ total_goods_received }}</p>
                        <p class="text-xs opacity-75 mt-1">
                            <i class="fas fa-arrow-up mr-1"></i>+8% from last month
                        </p>
                    </div>
                    <div class="bg-white bg-opacity-20 text-black p-3 rounded-full">
                        <i class="fas fa-box text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-r from-red-500 to-red-600 text-white shadow-lg rounded-xl p-6 transform hover:scale-105 transition-transform">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium opacity-90">Total Returns</h3>
                        <p class="text-3xl font-bold">{{ total_returns }}</p>
                        <p class="text-xs opacity-75 mt-1">
                            <i class="fas fa-arrow-down mr-1"></i>-5% from last month
                        </p>
                    </div>
                    <div class="bg-white bg-opacity-20 text-black p-3 rounded-full">
                        <i class="fas fa-undo text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white shadow-lg rounded-xl p-6 transform hover:scale-105 transition-transform">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium opacity-90">Active Suppliers</h3>
                        <p class="text-3xl font-bold">{{ active_suppliers|default:0 }}</p>
                        <p class="text-xs opacity-75 mt-1">
                            <i class="fas fa-arrow-up mr-1"></i>+3 new this month
                        </p>
                    </div>
                    <div class="bg-white bg-opacity-20 text-black p-3 rounded-full">
                        <i class="fas fa-users text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white shadow-lg rounded-xl p-6 border-l-4 border-indigo-500">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700">Average Order Value</h3>
                        <p class="text-2xl font-bold text-indigo-600">${{ avg_order_value|default:"0"|floatformat:2 }}</p>
                    </div>
                    <div class="text-indigo-500">
                        <i class="fas fa-chart-line text-3xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white shadow-lg rounded-xl p-6 border-l-4 border-yellow-500">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700">On-Time Delivery Rate</h3>
                        <p class="text-2xl font-bold text-yellow-600">{{ on_time_delivery_rate|default:"95"|floatformat:1 }}%</p>
                    </div>
                    <div class="text-yellow-500">
                        <i class="fas fa-clock text-3xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white shadow-lg rounded-xl p-6 border-l-4 border-teal-500">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700">Return Rate</h3>
                        <p class="text-2xl font-bold text-teal-600">{{ return_rate|default:"2.3"|floatformat:1 }}%</p>
                    </div>
                    <div class="text-teal-500">
                        <i class="fas fa-percentage text-3xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Monthly Purchase Orders Chart -->
            <div class="bg-white shadow-lg rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Monthly Purchase Orders</h2>
                    <div class="flex space-x-2">
                        <button class="text-blue-500 hover:text-blue-700 text-sm">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </button>
                    </div>
                </div>
                <div style="position: relative; height: 300px; background: linear-gradient(145deg, #f8fafc, #f1f5f9); border-radius: 8px; padding: 8px;">
                    <canvas id="purchaseOrdersChart"></canvas>
                </div>
            </div>

            <!-- Purchase Order Status Pie Chart -->
            <div class="bg-white shadow-lg rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Order Status Distribution</h2>
                    <div class="flex space-x-2">
                        <button class="text-blue-500 hover:text-blue-700 text-sm">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </button>
                    </div>
                </div>
                <div style="position: relative; height: 300px;">
                    <canvas id="orderStatusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Second Row Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Goods Receipt vs Returns Chart -->
            <div class="bg-white shadow-lg rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Goods Receipt vs Returns</h2>
                    <div class="flex space-x-2">
                        <button class="text-blue-500 hover:text-blue-700 text-sm">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </button>
                    </div>
                </div>
                <div style="position: relative; height: 300px;">
                    <canvas id="goodsReceiptChart"></canvas>
                </div>
            </div>

            <!-- Supplier Performance Chart -->
            <div class="bg-white shadow-lg rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Top Suppliers by Volume</h2>
                    <div class="flex space-x-2">
                        <button class="text-blue-500 hover:text-blue-700 text-sm">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </button>
                    </div>
                </div>
                <div style="position: relative; height: 300px;">
                    <canvas id="supplierChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Additional Analytics -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Purchase Trends -->
            <div class="bg-white shadow-lg rounded-xl p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Purchase Trends</h2>
                <div style="position: relative; height: 200px;">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>

            <!-- Delivery Performance -->
            <div class="bg-white shadow-lg rounded-xl p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Delivery Performance</h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">On Time</span>
                        <div class="flex items-center">
                            <div class="w-32 bg-gray-200 rounded-full h-2 mr-2">
                                <div class="bg-green-500 h-2 rounded-full" style="width: 85%"></div>
                            </div>
                            <span class="text-sm font-medium">85%</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Early</span>
                        <div class="flex items-center">
                            <div class="w-32 bg-gray-200 rounded-full h-2 mr-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 10%"></div>
                            </div>
                            <span class="text-sm font-medium">10%</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Late</span>
                        <div class="flex items-center">
                            <div class="w-32 bg-gray-200 rounded-full h-2 mr-2">
                                <div class="bg-red-500 h-2 rounded-full" style="width: 5%"></div>
                            </div>
                            <span class="text-sm font-medium">5%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="bg-white shadow-lg rounded-xl p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Recent Activities</h2>
                <div class="space-y-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <div class="flex-1">
                            <p class="text-sm text-gray-700">PO #12345 approved</p>
                            <p class="text-xs text-gray-500">2 hours ago</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                        <div class="flex-1">
                            <p class="text-sm text-gray-700">GRN #67890 received</p>
                            <p class="text-xs text-gray-500">4 hours ago</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
                        <div class="flex-1">
                            <p class="text-sm text-gray-700">Return #11223 processed</p>
                            <p class="text-xs text-gray-500">6 hours ago</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loading...');
            console.log('Chart.js version:', Chart.version);

            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded!');
                return;
            }

            // Chart.js configuration with modern styling
            Chart.defaults.font.family = 'Inter, system-ui, sans-serif';
            Chart.defaults.font.size = 12;

            // Provide default empty data if Django variables are not set
            const purchaseOrderLabels = {{ monthly_purchase_orders_labels|safe|default:"[]" }};
            const purchaseOrderData = {{ monthly_purchase_orders_data|safe|default:"[]" }};
            const goodsReceivedLabels = {{ monthly_goods_received_labels|safe|default:"[]" }};
            const goodsReceivedData = {{ monthly_goods_received_data|safe|default:"[]" }};
            const returnsData = {{ monthly_returns_data|safe|default:"[]" }};

            console.log('Data loaded:', {
                purchaseOrderLabels,
                purchaseOrderData,
                goodsReceivedLabels,
                goodsReceivedData,
                returnsData
            });

            // Monthly Purchase Orders Chart
            try {
                const purchaseOrdersCtx = document.getElementById('purchaseOrdersChart');
                if (purchaseOrdersCtx) {
                    new Chart(purchaseOrdersCtx, {
                        type: 'line',
                        data: {
                            labels: purchaseOrderLabels.length ? purchaseOrderLabels : ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                            datasets: [{
                                label: 'Purchase Orders',
                                data: purchaseOrderData.length ? purchaseOrderData : [12, 19, 15, 25, 22, 30],
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#10b981',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 6,
                                pointHoverRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    borderColor: '#10b981',
                                    borderWidth: 2,
                                    cornerRadius: 8
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        display: true,
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    },
                                    ticks: {
                                        color: '#374151',
                                        font: {
                                            size: 12,
                                            weight: '500'
                                        }
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    },
                                    ticks: {
                                        color: '#374151',
                                        font: {
                                            size: 12,
                                            weight: '500'
                                        }
                                    }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        }
                    });
                    console.log('Purchase Orders chart created');
                }
            } catch (error) {
                console.error('Error creating Purchase Orders chart:', error);
            }

            // Order Status Pie Chart
            try {
                const orderStatusCtx = document.getElementById('orderStatusChart');
                if (orderStatusCtx) {
                    new Chart(orderStatusCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Approved', 'Pending', 'Completed', 'Cancelled'],
                            datasets: [{
                                data: [45, 20, 30, 5],
                                backgroundColor: [
                                    '#10b981',  // Emerald for Approved
                                    '#f59e0b',  // Amber for Pending  
                                    '#3b82f6',  // Blue for Completed
                                    '#ef4444'   // Red for Cancelled
                                ],
                                borderColor: [
                                    '#059669',
                                    '#d97706', 
                                    '#2563eb',
                                    '#dc2626'
                                ],
                                borderWidth: 2,
                                hoverOffset: 6,
                                hoverBorderWidth: 3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20,
                                        color: '#1f2937',
                                        font: {
                                            size: 13,
                                            weight: '600'
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    cornerRadius: 8,
                                    borderColor: '#10b981',
                                    borderWidth: 1
                                }
                            },
                            cutout: '60%'
                        }
                    });
                    console.log('Order Status chart created');
                }
            } catch (error) {
                console.error('Error creating Order Status chart:', error);
            }

            // Goods Receipt vs Returns Chart
            try {
                const goodsReceiptCtx = document.getElementById('goodsReceiptChart');
                if (goodsReceiptCtx) {
                    new Chart(goodsReceiptCtx, {
                        type: 'bar',
                        data: {
                            labels: goodsReceivedLabels.length ? goodsReceivedLabels : ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                            datasets: [
                                {
                                    label: 'Goods Received',
                                    data: goodsReceivedData.length ? goodsReceivedData : [25, 35, 30, 40, 28, 45],
                                    backgroundColor: '#10b981',
                                    borderColor: '#059669',
                                    borderWidth: 2,
                                    borderRadius: 4,
                                    borderSkipped: false
                                },
                                {
                                    label: 'Returns',
                                    data: returnsData.length ? returnsData : [3, 5, 2, 4, 3, 6],
                                    backgroundColor: '#ef4444',
                                    borderColor: '#dc2626',
                                    borderWidth: 2,
                                    borderRadius: 4,
                                    borderSkipped: false
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20,
                                        color: '#1f2937',
                                        font: {
                                            size: 13,
                                            weight: '600'
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    cornerRadius: 8,
                                    borderColor: '#10b981',
                                    borderWidth: 1
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        display: true,
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    },
                                    ticks: {
                                        color: '#374151',
                                        font: {
                                            size: 12,
                                            weight: '500'
                                        }
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    },
                                    ticks: {
                                        color: '#374151',
                                        font: {
                                            size: 12,
                                            weight: '500'
                                        }
                                    }
                                }
                            }
                        }
                    });
                    console.log('Goods Receipt chart created');
                }
            } catch (error) {
                console.error('Error creating Goods Receipt chart:', error);
            }

            // Supplier Performance Chart (Fixed for Chart.js v3+)
            try {
                const supplierCtx = document.getElementById('supplierChart');
                if (supplierCtx) {
                    new Chart(supplierCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Supplier A', 'Supplier B', 'Supplier C', 'Supplier D', 'Supplier E'],
                            datasets: [{
                                label: 'Order Volume',
                                data: [85, 75, 65, 55, 45],
                                backgroundColor: [
                                    '#8b5cf6',  // Purple
                                    '#3b82f6',  // Blue
                                    '#10b981',  // Emerald
                                    '#f59e0b',  // Amber
                                    '#ef4444'   // Red
                                ],
                                borderColor: [
                                    '#7c3aed',
                                    '#2563eb', 
                                    '#059669',
                                    '#d97706',
                                    '#dc2626'
                                ],
                                borderWidth: 2,
                                borderRadius: 4,
                                borderSkipped: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: 'y', // This makes it horizontal
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    cornerRadius: 8,
                                    borderColor: '#10b981',
                                    borderWidth: 1
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    },
                                    ticks: {
                                        color: '#374151',
                                        font: {
                                            size: 12,
                                            weight: '500'
                                        }
                                    }
                                },
                                y: {
                                    grid: {
                                        display: true,
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    },
                                    ticks: {
                                        color: '#374151',
                                        font: {
                                            size: 12,
                                            weight: '500'
                                        }
                                    }
                                }
                            }
                        }
                    });
                    console.log('Supplier chart created');
                }
            } catch (error) {
                console.error('Error creating Supplier chart:', error);
            }

            // Purchase Trends Sparkline
            try {
                const trendsCtx = document.getElementById('trendsChart');
                if (trendsCtx) {
                    new Chart(trendsCtx, {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                            datasets: [{
                                data: [12, 19, 15, 25, 22, 30],
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    enabled: false
                                }
                            },
                            scales: {
                                x: {
                                    display: false
                                },
                                y: {
                                    display: false
                                }
                            },
                            elements: {
                                point: {
                                    radius: 0
                                }
                            }
                        }
                    });
                    console.log('Trends chart created');
                }
            } catch (error) {
                console.error('Error creating Trends chart:', error);
            }

            // Add hover effects to stat cards
            const statCards = document.querySelectorAll('.transform');
            statCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.05)';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1)';
                });
            });

            console.log('Dashboard fully loaded');
        });
    </script>
{% endblock %}
