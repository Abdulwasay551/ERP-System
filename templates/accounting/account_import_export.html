{% extends 'base.html' %}
{% load static %}

{% block title %}Import/Export - Accounting{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header Section -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Import/Export Accounts</h1>
            <p class="text-gray-600 mt-2">Import and export your chart of accounts data</p>
        </div>
        <div class="flex space-x-3">
            <button onclick="downloadTemplate()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                <i class="fas fa-download mr-2"></i>
                Download Template
            </button>
        </div>
    </div>

    {% if error %}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
            <strong>Error:</strong> {{ error }}
        </div>
    {% endif %}

    <!-- Import/Export Tabs -->
    <div class="bg-white rounded-lg shadow-md">
        <div class="border-b border-gray-200">
            <nav class="flex space-x-8 px-6" aria-label="Tabs">
                <button onclick="showTab('import')" class="import-export-tab active py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                    Import
                </button>
                <button onclick="showTab('export')" class="import-export-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    Export
                </button>
                <button onclick="showTab('history')" class="import-export-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    History
                </button>
            </nav>
        </div>

        <!-- Import Tab -->
        <div id="import-tab" class="tab-content p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Import Form -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-6">Import Accounts</h3>
                    
                    <form id="importForm" method="post" action="{% url 'accounting:import_accounts' %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Import Type</label>
                            <select name="import_type" class="form-select w-full" onchange="handleImportTypeChange(this.value)">
                                <option value="accounts">Accounts Only</option>
                                <option value="groups">Account Groups Only</option>
                                <option value="both">Accounts and Groups</option>
                                <option value="chart">Complete Chart of Accounts</option>
                            </select>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">File Format</label>
                            <select name="file_format" class="form-select w-full">
                                <option value="csv">CSV</option>
                                <option value="excel">Excel (XLSX)</option>
                                <option value="json">JSON</option>
                            </select>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Choose File</label>
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                <div class="space-y-1 text-center">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    <div class="flex text-sm text-gray-600">
                                        <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                            <span>Upload a file</span>
                                            <input id="file-upload" name="import_file" type="file" class="sr-only" accept=".csv,.xlsx,.json">
                                        </label>
                                        <p class="pl-1">or drag and drop</p>
                                    </div>
                                    <p class="text-xs text-gray-500">CSV, XLSX, JSON up to 10MB</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">Import Options</h4>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" name="update_existing" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                    <span class="ml-2 text-sm text-gray-700">Update existing accounts</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="create_groups" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                    <span class="ml-2 text-sm text-gray-700">Create missing account groups</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="validate_codes" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                    <span class="ml-2 text-sm text-gray-700">Validate account codes</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="backup_before" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                    <span class="ml-2 text-sm text-gray-700">Create backup before import</span>
                                </label>
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-upload mr-2"></i>
                            Import Accounts
                        </button>
                    </form>
                </div>
                
                <!-- Import Guidelines -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-6">Import Guidelines</h3>
                    
                    <div class="space-y-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-medium text-blue-900 mb-2">Required Fields</h4>
                            <ul class="text-sm text-blue-800 space-y-1">
                                <li>• Account Code (unique)</li>
                                <li>• Account Name</li>
                                <li>• Account Type</li>
                                <li>• Balance Side (Debit/Credit)</li>
                            </ul>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-medium text-green-900 mb-2">Optional Fields</h4>
                            <ul class="text-sm text-green-800 space-y-1">
                                <li>• Description</li>
                                <li>• Parent Account</li>
                                <li>• Account Group</li>
                                <li>• Tax Code</li>
                                <li>• Opening Balance</li>
                            </ul>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <h4 class="font-medium text-yellow-900 mb-2">Data Formats</h4>
                            <ul class="text-sm text-yellow-800 space-y-1">
                                <li>• Account Types: asset, liability, equity, income, expense, cogs</li>
                                <li>• Balance Side: debit, credit</li>
                                <li>• Status: active, inactive</li>
                                <li>• Numbers: Use decimal format (e.g., 1000.50)</li>
                            </ul>
                        </div>
                        
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 mb-2">Sample CSV Format</h4>
                            <pre class="text-xs text-gray-700 bg-white p-2 rounded border overflow-x-auto">
code,name,type,balance_side,description
1000,Cash,asset,debit,Cash on hand
1100,Bank Account,asset,debit,Primary bank account
2000,Accounts Payable,liability,credit,Supplier payments
3000,Capital,equity,credit,Owner equity
4000,Sales Revenue,income,credit,Product sales</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="export-tab" class="tab-content p-6 hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Export Form -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-6">Export Accounts</h3>
                    
                    <form id="exportForm" method="get" action="{% url 'accounting:export_accounts' %}">
                        {% csrf_token %}
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Export Type</label>
                            <select name="export_type" class="form-select w-full">
                                <option value="all">All Accounts</option>
                                <option value="active">Active Accounts Only</option>
                                <option value="by_type">By Account Type</option>
                                <option value="by_group">By Account Group</option>
                                <option value="chart">Complete Chart Structure</option>
                            </select>
                        </div>
                        
                        <div class="mb-6" id="typeFilter" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Account Types</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" name="types[]" value="asset" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Assets</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="types[]" value="liability" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Liabilities</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="types[]" value="equity" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Equity</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="types[]" value="income" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Income</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="types[]" value="expense" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Expenses</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">File Format</label>
                            <select name="export_format" class="form-select w-full">
                                <option value="csv">CSV</option>
                                <option value="excel">Excel (XLSX)</option>
                                <option value="json">JSON</option>
                                <option value="pdf">PDF Report</option>
                            </select>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">Include in Export</h4>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" name="include_balances" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                    <span class="ml-2 text-sm text-gray-700">Current balances</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="include_groups" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                    <span class="ml-2 text-sm text-gray-700">Account groups</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="include_inactive" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Inactive accounts</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="include_tax_codes" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Tax codes</span>
                                </label>
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>
                            Export Accounts
                        </button>
                    </form>
                </div>
                
                <!-- Export Options -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-6">Export Options</h3>
                    
                    <div class="space-y-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-medium text-blue-900 mb-2">CSV Format</h4>
                            <p class="text-sm text-blue-800">
                                Comma-separated values format. Best for importing into other accounting systems or spreadsheets.
                            </p>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-medium text-green-900 mb-2">Excel Format</h4>
                            <p class="text-sm text-green-800">
                                Microsoft Excel format with formatted columns and headers. Includes data validation and formatting.
                            </p>
                        </div>
                        
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <h4 class="font-medium text-purple-900 mb-2">JSON Format</h4>
                            <p class="text-sm text-purple-800">
                                JavaScript Object Notation format. Preserves hierarchy and relationships between accounts.
                            </p>
                        </div>
                        
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h4 class="font-medium text-red-900 mb-2">PDF Report</h4>
                            <p class="text-sm text-red-800">
                                Formatted report with chart of accounts structure. Suitable for printing and documentation.
                            </p>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h4 class="font-medium text-gray-900 mb-3">Quick Actions</h4>
                        <div class="space-y-2">
                            <button onclick="exportCurrentData('csv')" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg text-sm transition-colors">
                                <i class="fas fa-file-csv text-green-600 mr-2"></i>
                                Export All Accounts (CSV)
                            </button>
                            <button onclick="exportCurrentData('excel')" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg text-sm transition-colors">
                                <i class="fas fa-file-excel text-green-600 mr-2"></i>
                                Export All Accounts (Excel)
                            </button>
                            <button onclick="exportChart('pdf')" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg text-sm transition-colors">
                                <i class="fas fa-file-pdf text-red-600 mr-2"></i>
                                Chart of Accounts Report (PDF)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history-tab" class="tab-content p-6 hidden">
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Import/Export History</h3>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Operation</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Records</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for operation in operation_history %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {{ operation.created_at|date:"M d, Y H:i" }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    {% if operation.type == 'import' %}bg-blue-100 text-blue-800
                                    {% else %}bg-green-100 text-green-800{% endif %}">
                                    {{ operation.type|title }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ operation.data_type }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ operation.record_count }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if operation.status == 'completed' %}
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                        Completed
                                    </span>
                                {% elif operation.status == 'failed' %}
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                        Failed
                                    </span>
                                {% else %}
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                        Processing
                                    </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="viewOperationDetails('{{ operation.id }}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                    View
                                </button>
                                {% if operation.type == 'export' and operation.status == 'completed' %}
                                <button onclick="downloadFile('{{ operation.file_url }}')" class="text-green-600 hover:text-green-900">
                                    Download
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">No import/export history found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.import-export-tab').forEach(btn => {
        btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.remove('hidden');
    
    // Add active class to selected tab button
    event.target.classList.add('active', 'border-blue-500', 'text-blue-600');
    event.target.classList.remove('border-transparent', 'text-gray-500');
}

function handleImportTypeChange(type) {
    // Handle import type change
    console.log('Import type changed to:', type);
}

function downloadTemplate() {
    // Download import template
    window.location.href = '/accounting/import-export/template/';
}

function exportCurrentData(format) {
    // Quick export all data
    const form = new FormData();
    form.append('export_type', 'all');
    form.append('export_format', format);
    form.append('include_balances', 'on');
    form.append('include_groups', 'on');
    
    // Submit export request
    console.log('Exporting all data in', format, 'format');
}

function exportChart(format) {
    // Export chart of accounts
    const form = new FormData();
    form.append('export_type', 'chart');
    form.append('export_format', format);
    
    console.log('Exporting chart in', format, 'format');
}

function viewOperationDetails(operationId) {
    // View operation details
    window.location.href = '/accounting/import-export/history/' + operationId + '/';
}

function downloadFile(fileUrl) {
    // Download exported file
    window.open(fileUrl, '_blank');
}

// Form submissions
document.getElementById('importForm').addEventListener('submit', function(e) {
    e.preventDefault();
    // Handle import
    console.log('Processing import...');
});

document.getElementById('exportForm').addEventListener('submit', function(e) {
    e.preventDefault();
    // Handle export
    console.log('Processing export...');
});

// File upload handling
document.getElementById('file-upload').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        const fileName = e.target.files[0].name;
        console.log('File selected:', fileName);
    }
});

// Show/hide type filter based on export type
document.querySelector('select[name="export_type"]').addEventListener('change', function(e) {
    const typeFilter = document.getElementById('typeFilter');
    if (e.target.value === 'by_type') {
        typeFilter.style.display = 'block';
    } else {
        typeFilter.style.display = 'none';
    }
});
</script>
{% endblock %}
