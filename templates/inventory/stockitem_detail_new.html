{% extends "base.html" %}
{% block title %}{{ stockitem.product.name }} - Stock Details | FutureERP{% endblock %}

{% block extra_css %}
<style>
    .info-card {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(16, 185, 129, 0.1);
        backdrop-filter: blur(20px);
        transition: all 0.3s ease;
    }
    .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    .stock-level-low { color: #dc2626; }
    .stock-level-medium { color: #d97706; }
    .stock-level-good { color: #059669; }
    .movement-in { color: #059669; }
    .movement-out { color: #dc2626; }
    .movement-adjustment { color: #7c3aed; }
    .progress-ring {
        width: 120px;
        height: 120px;
    }
    .purchase-status-indicator {
        position: absolute;
        top: 1rem;
        right: 1rem;
        padding: 0.5rem 1rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        font-weight: 600;
    }
    .status-available {
        background: linear-gradient(135deg, #10b981, #065f46);
        color: white;
    }
    .status-locked {
        background: linear-gradient(135deg, #f59e0b, #92400e);
        color: white;
    }
    .status-low-stock {
        background: linear-gradient(135deg, #ef4444, #991b1b);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="pt-24 pb-8">
    <div class="mx-auto px-8">
        <!-- Breadcrumb -->
        <nav class="flex mb-6" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="{% url 'inventory_dashboard' %}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-green-600">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                        </svg>
                        Inventory
                    </a>
                </li>
                <li>
                    <div class="flex items-center">
                        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <a href="{% url 'inventory_stockitems_ui' %}" class="ml-1 text-sm font-medium text-gray-700 hover:text-green-600 md:ml-2">Stock Items</a>
                    </div>
                </li>
                <li aria-current="page">
                    <div class="flex items-center">
                        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">{{ stockitem.product.name }}</span>
                    </div>
                </li>
            </ol>
        </nav>

        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-bold accounting-highlight mb-2">
                    <svg class="w-10 h-10 inline mr-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    {{ stockitem.product.name }}
                </h1>
                <p class="text-gray-600">{{ stockitem.product.sku|default:"No SKU" }} | {{ stockitem.warehouse.name }}</p>
            </div>
            <div class="flex gap-4">
                <a href="{% url 'inventory_stockitems_ui' %}" class="action-btn bg-gray-500 text-white px-6 py-3 rounded-2xl hover-lift">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to List
                </a>
                <a href="{% url 'inventory_stockitems_edit' stockitem.pk %}" class="quick-action-btn text-white px-6 py-3 rounded-2xl hover-lift">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Edit Item
                </a>
            </div>
        </div>

        <!-- Stock Overview Cards -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Main Stock Info -->
            <div class="lg:col-span-2">
                <div class="info-card rounded-3xl shadow-lg p-8 relative">
                    <!-- Status Indicator -->
                    {% if stockitem.is_out_of_stock %}
                        <div class="purchase-status-indicator status-low-stock">
                            <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            Out of Stock
                        </div>
                    {% elif stockitem.is_low_stock %}
                        <div class="purchase-status-indicator status-low-stock">
                            <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            Low Stock
                        </div>
                    {% elif stockitem.locked_quantity > 0 %}
                        <div class="purchase-status-indicator status-locked">
                            <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                            </svg>
                            Partially Locked
                        </div>
                    {% else %}
                        <div class="purchase-status-indicator status-available">
                            <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            Available
                        </div>
                    {% endif %}

                    <h3 class="text-2xl font-bold text-green-800 mb-6">Stock Information</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 font-medium">Product:</span>
                                    <span class="font-semibold">{{ stockitem.product.name }}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 font-medium">SKU:</span>
                                    <span class="font-semibold">{{ stockitem.product.sku|default:"N/A" }}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 font-medium">Warehouse:</span>
                                    <span class="font-semibold">{{ stockitem.warehouse.name }}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 font-medium">Category:</span>
                                    <span class="font-semibold">{{ stockitem.category.name|default:"Uncategorized" }}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 font-medium">Location:</span>
                                    <span class="font-semibold">{{ stockitem.location|default:"No specific location" }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 font-medium">Total Quantity:</span>
                                    <span class="font-bold text-2xl">{{ stockitem.quantity|floatformat:2 }}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 font-medium">Available:</span>
                                    <span class="font-bold text-xl {% if stockitem.available_quantity <= stockitem.min_stock %}stock-level-low{% elif stockitem.available_quantity <= stockitem.reorder_point %}stock-level-medium{% else %}stock-level-good{% endif %}">
                                        {{ stockitem.available_quantity|floatformat:2 }}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 font-medium">Reserved:</span>
                                    <span class="font-semibold">{{ stockitem.reserved_quantity|floatformat:2 }}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 font-medium">Locked:</span>
                                    <span class="font-semibold">{{ stockitem.locked_quantity|floatformat:2 }}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 font-medium">Unit Cost:</span>
                                    <span class="font-semibold">₨{{ stockitem.average_cost|floatformat:2 }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stock Level Gauge -->
            <div class="info-card rounded-3xl shadow-lg p-8 text-center">
                <h3 class="text-xl font-bold text-green-800 mb-6">Stock Level</h3>
                
                <div class="flex justify-center mb-6">
                    <div class="relative">
                        <svg class="progress-ring" width="120" height="120">
                            <circle cx="60" cy="60" r="50" stroke="#e5e7eb" stroke-width="8" fill="transparent"/>
                            <circle cx="60" cy="60" r="50" 
                                    stroke="{% if stockitem.available_quantity <= stockitem.min_stock %}#dc2626{% elif stockitem.available_quantity <= stockitem.reorder_point %}#d97706{% else %}#059669{% endif %}"
                                    stroke-width="8" fill="transparent"
                                    stroke-dasharray="314.16"
                                    stroke-dashoffset="{{ stockitem.stock_level_percentage|floatformat:0|add:'-100'|add:'100'|mul:'3.1416' }}"
                                    stroke-linecap="round"
                                    transform="rotate(-90 60 60)"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="text-center">
                                <div class="text-2xl font-bold">{{ stockitem.stock_level_percentage|floatformat:0 }}%</div>
                                <div class="text-sm text-gray-600">Stock Level</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Min Stock:</span>
                        <span class="font-semibold">{{ stockitem.min_stock|floatformat:2 }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Reorder Point:</span>
                        <span class="font-semibold">{{ stockitem.reorder_point|floatformat:2 }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Max Stock:</span>
                        <span class="font-semibold">{{ stockitem.max_stock|floatformat:2|default:"Not set" }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchase Integration Info -->
        {% if purchase_info %}
        <div class="info-card rounded-3xl shadow-lg p-8 mb-8">
            <h3 class="text-2xl font-bold text-indigo-800 mb-6">
                <svg class="w-6 h-6 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                </svg>
                Purchase Integration
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center p-4 bg-yellow-50 rounded-xl">
                    <div class="text-2xl font-bold text-yellow-800">{{ purchase_info.pending_grns }}</div>
                    <div class="text-yellow-600">Pending GRNs</div>
                </div>
                <div class="text-center p-4 bg-blue-50 rounded-xl">
                    <div class="text-2xl font-bold text-blue-800">₨{{ purchase_info.pending_value|floatformat:2 }}</div>
                    <div class="text-blue-600">Pending Value</div>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-xl">
                    <div class="text-2xl font-bold text-purple-800">{{ purchase_info.bills_pending }}</div>
                    <div class="text-purple-600">Bills Pending</div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Stock Movements -->
        <div class="info-card rounded-3xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 px-8 py-6">
                <h3 class="text-2xl font-bold text-green-800">
                    <svg class="w-6 h-6 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                    </svg>
                    Recent Stock Movements
                </h3>
            </div>
            
            <div class="p-8">
                {% if movements %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-800 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-800 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-800 uppercase tracking-wider">Quantity</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-800 uppercase tracking-wider">Unit Cost</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-800 uppercase tracking-wider">Total Value</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-800 uppercase tracking-wider">Reference</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-800 uppercase tracking-wider">Notes</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-100">
                                {% for movement in movements %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        {{ movement.timestamp|date:"M d, Y H:i" }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        {% if movement.movement_type == 'in' %}
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                                                </svg>
                                                {{ movement.get_movement_type_display }}
                                            </span>
                                        {% elif movement.movement_type == 'out' %}
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                                </svg>
                                                {{ movement.get_movement_type_display }}
                                            </span>
                                        {% else %}
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                                                </svg>
                                                {{ movement.get_movement_type_display }}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm movement-{{ movement.movement_type }}">
                                        {% if movement.movement_type == 'in' %}+{% elif movement.movement_type == 'out' %}-{% endif %}{{ movement.quantity|floatformat:2 }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        ₨{{ movement.unit_cost|floatformat:2 }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        ₨{{ movement.total_value|floatformat:2 }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        {{ movement.reference_number|default:"-" }}
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-900">
                                        {{ movement.notes|default:"-" }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293L17 15.586a1 1 0 01-.707.293h-4.586a1 1 0 01-.707-.293L9.293 13.707A1 1 0 008.586 13H6"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No stock movements</h3>
                        <p class="mt-1 text-sm text-gray-500">No movements have been recorded for this stock item yet.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Auto-refresh data every 2 minutes
setTimeout(function() {
    location.reload();
}, 120000);

// Calculate stock level percentage for progress ring
document.addEventListener('DOMContentLoaded', function() {
    const stockLevel = {{ stockitem.stock_level_percentage|default:0 }};
    const circle = document.querySelector('.progress-ring circle:last-child');
    if (circle) {
        const circumference = 2 * Math.PI * 50;
        const offset = circumference - (stockLevel / 100) * circumference;
        circle.style.strokeDashoffset = offset;
    }
});
</script>

{% endblock %}
