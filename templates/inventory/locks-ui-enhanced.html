{% extends "base.html" %}
{% load static %}
{% csrf_token %}
{% block title %}Inventory Locks | ERP System{% endblock %}
{% block content %}
<!-- Inventory Locks Management -->
<div class="mt-16 p-8">
    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
        <div class="flex items-center">
            <svg class="w-5 h-5 text-orange-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
            </svg>
            <span class="text-orange-800 font-medium">Inventory Locks System:</span>
            <span class="text-orange-700 ml-2">Manage stock locks for quality control, pending bills, and business processes</span>
        </div>
    </div>

    <!-- Page Header -->
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Inventory Locks</h1>
            <p class="text-gray-600 mt-2">Track and manage locked inventory across all business processes</p>
        </div>
        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-4 lg:mt-0">
            <button onclick="openLockModal()" class="bg-gradient-to-r from-orange-600 to-orange-700 text-white px-6 py-3 rounded-lg hover:from-orange-700 hover:to-orange-800 transition-all duration-200 shadow-md">
                <i class="fas fa-lock mr-2"></i>Create Lock
            </button>
            <button onclick="showBulkUnlock()" class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-3 rounded-lg hover:from-green-700 hover:to-green-800 transition-all duration-200 shadow-md">
                <i class="fas fa-unlock mr-2"></i>Bulk Unlock
            </button>
            <button onclick="exportLocks()" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-200 shadow-md">
                <i class="fas fa-download mr-2"></i>Export
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-orange-100">Active Locks</p>
                    <p class="text-3xl font-bold">{{ active_locks|default:0 }}</p>
                </div>
                <svg class="w-12 h-12 text-orange-200" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                </svg>
            </div>
        </div>

        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-blue-100">GRN Pending Bills</p>
                    <p class="text-3xl font-bold">{{ grn_pending_count|default:0 }}</p>
                </div>
                <svg class="w-12 h-12 text-blue-200" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                    <polyline points="14,2 14,8 20,8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10,9 9,9 8,9"/>
                </svg>
            </div>
        </div>

        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-purple-100">Quality Holds</p>
                    <p class="text-3xl font-bold">{{ quality_holds_count|default:0 }}</p>
                </div>
                <svg class="w-12 h-12 text-purple-200" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                </svg>
            </div>
        </div>

        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-red-100">Expired Locks</p>
                    <p class="text-3xl font-bold">{{ expired_locks|default:0 }}</p>
                </div>
                <svg class="w-12 h-12 text-red-200" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
            </div>
        </div>

        <div class="bg-gradient-to-br from-gray-500 to-gray-600 rounded-xl p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-100">Total Value Locked</p>
                    <p class="text-3xl font-bold">{{ total_locked_value|default:"0"|floatformat:0 }}</p>
                </div>
                <svg class="w-12 h-12 text-gray-200" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/>
                </svg>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Lock Type</label>
                <select id="lockTypeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500">
                    <option value="">All Types</option>
                    <option value="grn_pending_bill">GRN Pending Bill</option>
                    <option value="quality_inspection">Quality Inspection</option>
                    <option value="quality_failed">Quality Failed</option>
                    <option value="sales_order">Sales Order</option>
                    <option value="return_processing">Return Processing</option>
                    <option value="manual">Manual Lock</option>
                    <option value="audit_hold">Audit Hold</option>
                    <option value="legal_hold">Legal Hold</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="expired">Expired</option>
                    <option value="unlocked">Unlocked</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                <select id="priorityFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500">
                    <option value="">All Priorities</option>
                    <option value="1">High (1)</option>
                    <option value="2">High (2)</option>
                    <option value="3">Medium (3)</option>
                    <option value="4">Medium (4)</option>
                    <option value="5">Normal (5)</option>
                    <option value="6">Low (6)</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Locked By</label>
                <select id="lockedByFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500">
                    <option value="">All Users</option>
                    {% for user in locked_by_users %}
                    <option value="{{ user.id }}">{{ user.get_full_name|default:user.email }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                <input type="text" id="searchLocks" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" placeholder="Search products...">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Actions</label>
                <button onclick="clearFilters()" class="w-full bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                    <i class="fas fa-times mr-2"></i>Clear
                </button>
            </div>
        </div>
    </div>

    <!-- Locks Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left">
                            <input type="checkbox" id="selectAll" class="rounded border-gray-300 text-orange-600 focus:ring-orange-500">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lock Details</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity & Value</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reference</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timing</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for lock in locks %}
                    <tr class="hover:bg-gray-50 lock-row" data-lock-id="{{ lock.id }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" class="lock-checkbox rounded border-gray-300 text-orange-600 focus:ring-orange-500" value="{{ lock.id }}">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                {% if lock.stock_item.product.image %}
                                <img class="h-10 w-10 rounded-lg object-cover mr-3" src="{{ lock.stock_item.product.image.url }}" alt="{{ lock.stock_item.product.name }}">
                                {% else %}
                                <div class="h-10 w-10 rounded-lg bg-gray-200 flex items-center justify-center mr-3">
                                    <i class="fas fa-box text-gray-400"></i>
                                </div>
                                {% endif %}
                                <div>
                                    <div class="text-sm font-medium text-gray-900">{{ lock.stock_item.product.name }}</div>
                                    <div class="text-sm text-gray-500">{{ lock.stock_item.product.sku }}</div>
                                    <div class="text-xs text-gray-400">@ {{ lock.stock_item.warehouse.name }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm">
                                <div class="font-medium text-gray-900">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                        {% if lock.lock_type == 'grn_pending_bill' %}bg-blue-100 text-blue-800
                                        {% elif lock.lock_type == 'quality_inspection' %}bg-purple-100 text-purple-800
                                        {% elif lock.lock_type == 'quality_failed' %}bg-red-100 text-red-800
                                        {% elif lock.lock_type == 'sales_order' %}bg-green-100 text-green-800
                                        {% elif lock.lock_type == 'manual' %}bg-yellow-100 text-yellow-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ lock.get_lock_type_display }}
                                    </span>
                                </div>
                                <div class="text-gray-500 mt-1">
                                    Priority: <span class="font-medium">{{ lock.priority }}</span>
                                </div>
                                {% if lock.reason %}
                                <div class="text-xs text-gray-400 mt-1" title="{{ lock.reason }}">
                                    {{ lock.reason|truncatechars:30 }}
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm">
                                <div class="font-medium text-gray-900">{{ lock.locked_quantity|floatformat:2 }} units</div>
                                {% if lock.stock_item.average_cost %}
                                {% with total_value=lock.locked_quantity|floatformat:2 %}
                                <div class="text-gray-500">Value: ${% widthratio lock.locked_quantity 1 lock.stock_item.average_cost %}</div>
                                {% endwith %}
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if lock.reference_number %}
                                <div class="text-sm font-medium text-gray-900">{{ lock.reference_number }}</div>
                                <div class="text-xs text-gray-500">{{ lock.get_reference_type_display }}</div>
                            {% else %}
                                <span class="text-gray-400">No reference</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div>Locked: {{ lock.locked_at|date:"M d, Y H:i" }}</div>
                            <div class="text-xs">By: {{ lock.locked_by.get_full_name|default:lock.locked_by.email }}</div>
                            {% if lock.expires_at %}
                                <div class="text-xs {% if lock.expires_at < today %}text-red-600{% elif lock.expires_at <= week_from_now %}text-yellow-600{% endif %}">
                                    Expires: {{ lock.expires_at|date:"M d, Y H:i" }}
                                </div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if not lock.is_active %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    Unlocked
                                </span>
                                {% if lock.unlocked_at %}
                                <div class="text-xs text-gray-500 mt-1">{{ lock.unlocked_at|date:"M d, H:i" }}</div>
                                {% endif %}
                            {% elif lock.expires_at and lock.expires_at < today %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    Expired
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                    Active
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="viewLockDetails({{ lock.id }})" class="text-blue-600 hover:text-blue-900" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if lock.is_active %}
                                <button onclick="unlockInventory({{ lock.id }})" class="text-green-600 hover:text-green-900" title="Unlock">
                                    <i class="fas fa-unlock"></i>
                                </button>
                                {% endif %}
                                <button onclick="editLock({{ lock.id }})" class="text-indigo-600 hover:text-indigo-900" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                {% if lock.expires_at and lock.expires_at < today %}
                                <button onclick="extendLock({{ lock.id }})" class="text-yellow-600 hover:text-yellow-900" title="Extend">
                                    <i class="fas fa-clock"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center">
                            <div class="text-gray-400">
                                <i class="fas fa-lock text-6xl mb-4"></i>
                                <p class="text-xl font-medium text-gray-500">No inventory locks found</p>
                                <p class="text-gray-400">Create your first inventory lock to get started</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Previous</a>
                {% endif %}
                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Next</a>
                {% endif %}
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Showing <span class="font-medium">{{ page_obj.start_index }}</span> to <span class="font-medium">{{ page_obj.end_index }}</span> of <span class="font-medium">{{ page_obj.paginator.count }}</span> results
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                        {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">Previous</a>
                        {% endif %}
                        {% for num in page_obj.paginator.page_range %}
                            {% if num == page_obj.number %}
                            <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-orange-50 text-sm font-medium text-orange-600">{{ num }}</span>
                            {% else %}
                            <a href="?page={{ num }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">{{ num }}</a>
                            {% endif %}
                        {% endfor %}
                        {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">Next</a>
                        {% endif %}
                    </nav>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Create Lock Modal -->
<div id="createLockModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between pb-3 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Create Inventory Lock</h3>
                <button onclick="closeModal('createLockModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="createLockForm" class="mt-6">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Stock Item</label>
                        <select name="stock_item" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500">
                            <option value="">Select Stock Item</option>
                            {% for item in stock_items %}
                            <option value="{{ item.id }}" data-available="{{ item.available_quantity }}">
                                {{ item.product.name }} @ {{ item.warehouse.name }} ({{ item.available_quantity }} available)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lock Quantity</label>
                        <input type="number" name="locked_quantity" required min="0.01" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" placeholder="0.00">
                        <p class="text-xs text-gray-500 mt-1">Available: <span id="availableQty">0</span></p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lock Type</label>
                        <select name="lock_type" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500">
                            <option value="">Select Lock Type</option>
                            <option value="grn_pending_bill">GRN Pending Bill</option>
                            <option value="quality_inspection">Quality Inspection</option>
                            <option value="quality_failed">Quality Failed</option>
                            <option value="sales_order">Sales Order</option>
                            <option value="production_order">Production Order</option>
                            <option value="return_processing">Return Processing</option>
                            <option value="audit_hold">Audit Hold</option>
                            <option value="legal_hold">Legal Hold</option>
                            <option value="manual">Manual Lock</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                        <select name="priority" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500">
                            <option value="1">High (1)</option>
                            <option value="2">High (2)</option>
                            <option value="3">Medium (3)</option>
                            <option value="4">Medium (4)</option>
                            <option value="5" selected>Normal (5)</option>
                            <option value="6">Low (6)</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reference Type</label>
                        <select name="reference_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500">
                            <option value="">Select Reference Type</option>
                            <option value="grn">Goods Receipt Note</option>
                            <option value="bill">Purchase Bill</option>
                            <option value="sales_order">Sales Order</option>
                            <option value="production_order">Production Order</option>
                            <option value="quality_check">Quality Check</option>
                            <option value="audit">Audit Document</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reference Number</label>
                        <input type="text" name="reference_number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" placeholder="e.g., GRN-2025-001">
                    </div>
                </div>
                
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Expiry Date & Time (Optional)</label>
                    <input type="datetime-local" name="expires_at" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500">
                </div>
                
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Lock Reason</label>
                    <textarea name="reason" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" placeholder="Reason for locking this inventory..."></textarea>
                </div>
                
                <div class="flex items-center mt-6">
                    <input type="checkbox" name="requires_approval_to_unlock" class="rounded border-gray-300 text-orange-600 focus:ring-orange-500">
                    <label class="ml-2 text-sm text-gray-700">Requires approval to unlock</label>
                </div>
                
                <div class="flex justify-end space-x-4 pt-6 border-t mt-6">
                    <button type="button" onclick="closeModal('createLockModal')" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700">Create Lock</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Unlock Modal -->
<div id="unlockModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between pb-3 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Unlock Inventory</h3>
                <button onclick="closeModal('unlockModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="unlockForm" class="mt-6">
                {% csrf_token %}
                <input type="hidden" name="lock_id" id="unlockLockId">
                
                <div id="unlockLockDetails" class="bg-gray-50 rounded-lg p-4 mb-6">
                    <!-- Lock details will be populated here -->
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Unlock Reason</label>
                    <textarea name="unlock_reason" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500" placeholder="Reason for unlocking this inventory..."></textarea>
                </div>
                
                <div class="flex justify-end space-x-4 pt-6 border-t mt-6">
                    <button type="button" onclick="closeModal('unlockModal')" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        <i class="fas fa-unlock mr-2"></i>Unlock Inventory
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Unlock Modal -->
<div id="bulkUnlockModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between pb-3 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Bulk Unlock Inventory</h3>
                <button onclick="closeModal('bulkUnlockModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="bulkUnlockForm" class="mt-6">
                {% csrf_token %}
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <p class="text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        <span id="selectedCount">0</span> locks selected for bulk unlock
                    </p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Bulk Unlock Reason</label>
                    <textarea name="bulk_unlock_reason" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500" placeholder="Reason for bulk unlocking selected inventory locks..."></textarea>
                </div>
                
                <div class="flex justify-end space-x-4 pt-6 border-t mt-6">
                    <button type="button" onclick="closeModal('bulkUnlockModal')" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        <i class="fas fa-unlock mr-2"></i>Bulk Unlock
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set up event listeners
    setupEventListeners();
    setupFilters();
    
    // Auto-refresh every 30 seconds for lock status
    setInterval(refreshLockStatus, 30000);
});

function setupEventListeners() {
    // Modal close on backdrop click
    const modals = ['createLockModal', 'unlockModal', 'bulkUnlockModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal(modalId);
                }
            });
        }
    });
    
    // Select all checkbox
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.lock-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectedCount();
    });
    
    // Individual checkboxes
    document.querySelectorAll('.lock-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
    
    // Stock item selection
    const stockItemSelect = document.querySelector('select[name="stock_item"]');
    if (stockItemSelect) {
        stockItemSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const availableQty = selectedOption.getAttribute('data-available') || '0';
            document.getElementById('availableQty').textContent = availableQty;
        });
    }
    
    // Form submissions
    document.getElementById('createLockForm').addEventListener('submit', handleCreateLock);
    document.getElementById('unlockForm').addEventListener('submit', handleUnlock);
    document.getElementById('bulkUnlockForm').addEventListener('submit', handleBulkUnlock);
}

function setupFilters() {
    // Filter event listeners
    document.getElementById('lockTypeFilter').addEventListener('change', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('priorityFilter').addEventListener('change', applyFilters);
    document.getElementById('lockedByFilter').addEventListener('change', applyFilters);
    document.getElementById('searchLocks').addEventListener('input', applyFilters);
}

function openLockModal() {
    document.getElementById('createLockModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
    document.body.style.overflow = 'auto';
}

async function handleCreateLock(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    try {
        const response = await fetch('/inventory/locks/create/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                closeModal('createLockModal');
                showNotification('Inventory lock created successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('Error: ' + (result.error || 'Unknown error'), 'error');
            }
        }
    } catch (error) {
        showNotification('Error creating lock', 'error');
    }
}

async function unlockInventory(lockId) {
    try {
        // Get lock details first
        const response = await fetch(`/inventory/locks/${lockId}/details/`);
        if (response.ok) {
            const lockData = await response.json();
            
            // Populate unlock modal
            document.getElementById('unlockLockId').value = lockId;
            document.getElementById('unlockLockDetails').innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="font-medium">Product:</span> ${lockData.product_name}
                    </div>
                    <div>
                        <span class="font-medium">Quantity:</span> ${lockData.locked_quantity}
                    </div>
                    <div>
                        <span class="font-medium">Lock Type:</span> ${lockData.lock_type_display}
                    </div>
                    <div>
                        <span class="font-medium">Reference:</span> ${lockData.reference_number || 'N/A'}
                    </div>
                </div>
            `;
            
            document.getElementById('unlockModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
    } catch (error) {
        showNotification('Error loading lock details', 'error');
    }
}

async function handleUnlock(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    try {
        const response = await fetch(`/inventory/locks/${formData.get('lock_id')}/unlock/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                closeModal('unlockModal');
                showNotification('Inventory unlocked successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('Error: ' + (result.error || 'Unknown error'), 'error');
            }
        }
    } catch (error) {
        showNotification('Error unlocking inventory', 'error');
    }
}

function showBulkUnlock() {
    const selectedLocks = document.querySelectorAll('.lock-checkbox:checked');
    if (selectedLocks.length === 0) {
        showNotification('Please select locks to unlock', 'warning');
        return;
    }
    
    document.getElementById('bulkUnlockModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

async function handleBulkUnlock(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    // Get selected lock IDs
    const selectedLocks = Array.from(document.querySelectorAll('.lock-checkbox:checked')).map(cb => cb.value);
    formData.append('lock_ids', JSON.stringify(selectedLocks));
    
    try {
        const response = await fetch('/inventory/locks/bulk-unlock/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                closeModal('bulkUnlockModal');
                showNotification(`${result.unlocked_count} locks unlocked successfully!`, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('Error: ' + (result.error || 'Unknown error'), 'error');
            }
        }
    } catch (error) {
        showNotification('Error performing bulk unlock', 'error');
    }
}

function updateSelectedCount() {
    const selectedCount = document.querySelectorAll('.lock-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = selectedCount;
}

function applyFilters() {
    const lockType = document.getElementById('lockTypeFilter').value;
    const status = document.getElementById('statusFilter').value;
    const priority = document.getElementById('priorityFilter').value;
    const lockedBy = document.getElementById('lockedByFilter').value;
    const search = document.getElementById('searchLocks').value.toLowerCase();
    
    const rows = document.querySelectorAll('.lock-row');
    
    rows.forEach(row => {
        let show = true;
        
        // Search filter
        if (search && !row.textContent.toLowerCase().includes(search)) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

function clearFilters() {
    document.getElementById('lockTypeFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('priorityFilter').value = '';
    document.getElementById('lockedByFilter').value = '';
    document.getElementById('searchLocks').value = '';
    applyFilters();
}

function viewLockDetails(lockId) {
    window.open(`/inventory/locks/${lockId}/details/`, '_blank');
}

function editLock(lockId) {
    // Navigate to edit lock page
    window.location.href = `/inventory/locks/${lockId}/edit/`;
}

function extendLock(lockId) {
    // Navigate to extend lock page  
    window.location.href = `/inventory/locks/${lockId}/extend/`;
}

function exportLocks() {
    // Build URL with current filters
    const statusFilter = document.getElementById('statusFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const dateFromFilter = document.getElementById('dateFromFilter').value;
    const dateToFilter = document.getElementById('dateToFilter').value;
    
    let exportUrl = '/inventory/locks/export/?';
    
    const params = new URLSearchParams();
    if (statusFilter) params.append('status', statusFilter);
    if (typeFilter) params.append('lock_type', typeFilter);
    if (dateFromFilter) params.append('date_from', dateFromFilter);
    if (dateToFilter) params.append('date_to', dateToFilter);
    
    exportUrl += params.toString();
    
    window.open(exportUrl, '_blank');
}

function refreshLockStatus() {
    // Auto-refresh lock status without reloading the page
    fetch('/inventory/locks/status/', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Update statistics
        document.querySelector('.stat-card:nth-child(1) .text-3xl').textContent = data.active_locks || 0;
        document.querySelector('.stat-card:nth-child(2) .text-3xl').textContent = data.grn_pending_count || 0;
        document.querySelector('.stat-card:nth-child(3) .text-3xl').textContent = data.quality_holds_count || 0;
        document.querySelector('.stat-card:nth-child(4) .text-3xl').textContent = data.expired_locks || 0;
        document.querySelector('.stat-card:nth-child(5) .text-3xl').textContent = data.total_locked_value || 0;
    })
    .catch(error => console.log('Lock status refresh failed'));
}

function showNotification(message, type) {
    // Simple notification function
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 
        type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %}
