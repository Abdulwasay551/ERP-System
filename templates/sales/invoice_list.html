{% extends "base.html" %}
{% load static %}

{% block title %}Invoices - Sales{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-6">
    <div class="mx-auto max-w-7xl">
        <!-- Header Section -->
        <div class="mb-8">
            <div class="md:flex md:items-center md:justify-between">
                <div class="min-w-0 flex-1">
                    <h1 class="text-3xl font-bold leading-tight tracking-tight text-gray-900">
                        Invoices
                    </h1>
                    <p class="mt-1 text-sm text-gray-500">
                        Manage your sales invoices and track payments
                    </p>
                </div>
                <div class="mt-4 flex md:ml-4 md:mt-0">
                    <a href="{% url 'sales:invoices_create' %}"
                       class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                        <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                        </svg>
                        New Invoice
                    </a>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="p-6">
                <form method="GET" id="filter-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4">
                    <!-- Search Input -->
                    <div class="lg:col-span-2">
                        <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <input type="text" 
                                   name="search" 
                                   id="search"
                                   value="{{ request.GET.search }}" 
                                   placeholder="Search by invoice number, customer..." 
                                   class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        </div>
                    </div>

                    <!-- Status Filter -->
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select name="status" 
                                id="status"
                                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                            <option value="">All Statuses</option>
                            <option value="draft" {% if request.GET.status == 'draft' %}selected{% endif %}>Draft</option>
                            <option value="sent" {% if request.GET.status == 'sent' %}selected{% endif %}>Sent</option>
                            <option value="paid" {% if request.GET.status == 'paid' %}selected{% endif %}>Paid</option>
                            <option value="overdue" {% if request.GET.status == 'overdue' %}selected{% endif %}>Overdue</option>
                            <option value="cancelled" {% if request.GET.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                        </select>
                    </div>

                    <!-- Customer Filter -->
                    <div>
                        <label for="customer" class="block text-sm font-medium text-gray-700 mb-1">Customer</label>
                        <select name="customer" 
                                id="customer"
                                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                            <option value="">All Customers</option>
                            {% for customer in customers %}
                                <option value="{{ customer.id }}" {% if request.GET.customer == customer.id|stringformat:"s" %}selected{% endif %}>
                                    {{ customer.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Date From -->
                    <div>
                        <label for="date_from" class="block text-sm font-medium text-gray-700 mb-1">Date From</label>
                        <input type="date" 
                               name="date_from" 
                               id="date_from"
                               value="{{ request.GET.date_from }}"
                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    </div>

                    <!-- Date To -->
                    <div>
                        <label for="date_to" class="block text-sm font-medium text-gray-700 mb-1">Date To</label>
                        <input type="date" 
                               name="date_to" 
                               id="date_to"
                               value="{{ request.GET.date_to }}"
                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    </div>

                    <!-- Filter Buttons -->
                    <div class="flex items-end space-x-2">
                        <button type="submit" 
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <svg class="-ml-1 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z"></path>
                            </svg>
                            Filter
                        </button>
                        <a href="{% url 'sales:invoices' %}" 
                           class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>
        <!-- Results Summary -->
        {% if invoices %}
        <div class="mb-4 text-sm text-gray-600">
            Showing {{ invoices|length }} of {{ total_count }} invoice{{ total_count|pluralize }}
            {% if request.GET.search %}
                for "<strong>{{ request.GET.search }}</strong>"
            {% endif %}
        </div>
        {% endif %}

        <!-- Invoices Table -->
        <div class="bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden">
            {% if invoices %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Invoice
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Customer
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Date
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Due Date
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Amount
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status
                                </th>
                                <th scope="col" class="relative px-6 py-3">
                                    <span class="sr-only">Actions</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for invoice in invoices %}
                            <tr class="hover:bg-gray-50 transition-colors duration-150">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">
                                                <a href="{% url 'sales:invoice_detail' invoice.id %}" 
                                                   class="text-indigo-600 hover:text-indigo-900">
                                                    {{ invoice.invoice_number }}
                                                </a>
                                            </div>
                                            {% if invoice.reference %}
                                                <div class="text-sm text-gray-500">
                                                    Ref: {{ invoice.reference }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">{{ invoice.customer.name }}</div>
                                    {% if invoice.customer.email %}
                                        <div class="text-sm text-gray-500">{{ invoice.customer.email }}</div>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    {{ invoice.invoice_date|date:"M d, Y" }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">{{ invoice.due_date|date:"M d, Y" }}</div>
                                    {% if invoice.is_overdue %}
                                        <div class="text-xs text-red-600">
                                            {{ invoice.days_overdue }} day{{ invoice.days_overdue|pluralize }} overdue
                                        </div>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">
                                        {{ invoice.currency.symbol }}{{ invoice.total_amount|floatformat:2 }}
                                    </div>
                                    {% if invoice.amount_paid > 0 %}
                                        <div class="text-xs text-gray-500">
                                            Paid: {{ invoice.currency.symbol }}{{ invoice.amount_paid|floatformat:2 }}
                                        </div>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if invoice.status == 'draft' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                            Draft
                                        </span>
                                    {% elif invoice.status == 'sent' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            Sent
                                        </span>
                                    {% elif invoice.status == 'paid' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            Paid
                                        </span>
                                    {% elif invoice.status == 'overdue' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                            Overdue
                                        </span>
                                    {% elif invoice.status == 'cancelled' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                            Cancelled
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <div class="flex items-center justify-end space-x-2">
                                        <a href="{% url 'sales:invoice_detail' invoice.id %}" 
                                           class="text-indigo-600 hover:text-indigo-900 text-sm">
                                            View
                                        </a>
                                        <button onclick="editInvoice({{ invoice.id }})" 
                                                class="text-indigo-600 hover:text-indigo-900 text-sm">
                                            Edit
                                        </button>
                                        {% if invoice.status == 'draft' %}
                                            <button onclick="sendInvoice({{ invoice.id }})" 
                                                    class="text-green-600 hover:text-green-900 text-sm">
                                                Send
                                            </button>
                                        {% endif %}
                                        {% if invoice.status in 'sent,overdue' and invoice.amount_paid < invoice.total_amount %}
                                            <button onclick="markPaid({{ invoice.id }})" 
                                                    class="text-blue-600 hover:text-blue-900 text-sm">
                                                Mark Paid
                                            </button>
                                        {% endif %}
                                        <button onclick="deleteInvoice({{ invoice.id }}, '{{ invoice.invoice_number }}')" 
                                                class="text-red-600 hover:text-red-900 text-sm">
                                            Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if is_paginated %}
                <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6">
                    <div class="flex-1 flex justify-between sm:hidden">
                        {% if page_obj.has_previous %}
                            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.customer %}&customer={{ request.GET.customer }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}" 
                               class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Previous
                            </a>
                        {% endif %}
                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.customer %}&customer={{ request.GET.customer }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}" 
                               class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Next
                            </a>
                        {% endif %}
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                Showing page 
                                <span class="font-medium">{{ page_obj.number }}</span>
                                of 
                                <span class="font-medium">{{ page_obj.paginator.num_pages }}</span>
                                ({{ page_obj.paginator.count }} total invoice{{ page_obj.paginator.count|pluralize }})
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                {% if page_obj.has_previous %}
                                    <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.customer %}&customer={{ request.GET.customer }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}" 
                                       class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                        First
                                    </a>
                                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.customer %}&customer={{ request.GET.customer }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}" 
                                       class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                        Previous
                                    </a>
                                {% endif %}
                                
                                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                    Page {{ page_obj.number }}
                                </span>
                                
                                {% if page_obj.has_next %}
                                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.customer %}&customer={{ request.GET.customer }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}" 
                                       class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                        Next
                                    </a>
                                    <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.customer %}&customer={{ request.GET.customer }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}" 
                                       class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                        Last
                                    </a>
                                {% endif %}
                            </nav>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% else %}
                <div class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No invoices found</h3>
                    <p class="mt-1 text-sm text-gray-500">
                        {% if request.GET.search or request.GET.status or request.GET.customer or request.GET.date_from or request.GET.date_to %}
                            Try adjusting your search filters.
                        {% else %}
                            Get started by creating your first invoice.
                        {% endif %}
                    </p>
                    <div class="mt-6">
                        <button type="button" 
                                onclick="openAddInvoiceModal()"
                                class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <svg class="-ml-1 mr-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                            </svg>
                            New Invoice
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add/Edit Invoice Modal -->
<div id="invoiceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <!-- Modal Header -->
            <div class="flex items-center justify-between pb-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900" id="modal-title">Add New Invoice</h3>
                <button type="button" onclick="closeInvoiceModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Modal Content -->
            <form id="invoiceForm" class="mt-6">
                {% csrf_token %}
                <input type="hidden" id="invoice_id" name="invoice_id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Customer Selection -->
                    <div>
                        <label for="customer_id" class="block text-sm font-medium text-gray-700 mb-1">Customer *</label>
                        <select id="customer_id" name="customer_id" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Select Customer</option>
                            {% for customer in customers %}
                                <option value="{{ customer.id }}">{{ customer.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Sales Order Reference -->
                    <div>
                        <label for="sales_order_id" class="block text-sm font-medium text-gray-700 mb-1">Sales Order</label>
                        <select id="sales_order_id" name="sales_order_id" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">No Sales Order</option>
                        </select>
                    </div>

                    <!-- Invoice Date -->
                    <div>
                        <label for="invoice_date" class="block text-sm font-medium text-gray-700 mb-1">Invoice Date *</label>
                        <input type="date" id="invoice_date" name="invoice_date" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <!-- Due Date -->
                    <div>
                        <label for="due_date" class="block text-sm font-medium text-gray-700 mb-1">Due Date *</label>
                        <input type="date" id="due_date" name="due_date" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <!-- Currency -->
                    <div>
                        <label for="currency_id" class="block text-sm font-medium text-gray-700 mb-1">Currency</label>
                        <select id="currency_id" name="currency_id" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            {% for currency in currencies %}
                                <option value="{{ currency.id }}" {% if currency.is_default %}selected{% endif %}>
                                    {{ currency.code }} - {{ currency.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Reference -->
                    <div>
                        <label for="reference" class="block text-sm font-medium text-gray-700 mb-1">Reference</label>
                        <input type="text" id="reference" name="reference"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <!-- Terms and Conditions -->
                <div class="mt-6">
                    <label for="terms_conditions" class="block text-sm font-medium text-gray-700 mb-1">Terms & Conditions</label>
                    <textarea id="terms_conditions" name="terms_conditions" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <!-- Line Items Section -->
                <div class="mt-8">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-medium text-gray-900">Line Items</h4>
                        <button type="button" onclick="addLineItem()" 
                                class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <svg class="-ml-0.5 mr-2 h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                            </svg>
                            Add Item
                        </button>
                    </div>

                    <div id="lineItems" class="space-y-4">
                        <!-- Line items will be added here dynamically -->
                    </div>

                    <!-- Totals Section -->
                    <div class="mt-6 border-t pt-4">
                        <div class="flex justify-end">
                            <div class="w-64 space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Subtotal:</span>
                                    <span id="subtotal" class="text-sm font-medium">$0.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Tax:</span>
                                    <span id="tax_amount" class="text-sm font-medium">$0.00</span>
                                </div>
                                <div class="flex justify-between border-t pt-2">
                                    <span class="text-base font-medium">Total:</span>
                                    <span id="total" class="text-base font-bold">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="mt-8 flex items-center justify-end space-x-3 pt-6 border-t border-gray-200">
                    <button type="button" 
                            onclick="closeInvoiceModal()"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <span id="submit-text">Create Invoice</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Global variables
let lineItemCounter = 0;
let products = [];
let taxes = [];
let isEditing = false;

// Load initial data
document.addEventListener('DOMContentLoaded', function() {
    // Set default dates
    const today = new Date();
    const invoiceDate = document.getElementById('invoice_date');
    const dueDate = document.getElementById('due_date');
    
    invoiceDate.value = today.toISOString().split('T')[0];
    
    // Set due date to 30 days from now
    const due = new Date(today);
    due.setDate(due.getDate() + 30);
    dueDate.value = due.toISOString().split('T')[0];

    // Load products and taxes
    loadProducts();
    loadTaxes();
});

// Modal functions
function openAddInvoiceModal() {
    isEditing = false;
    document.getElementById('modal-title').textContent = 'Add New Invoice';
    document.getElementById('submit-text').textContent = 'Create Invoice';
    document.getElementById('invoiceForm').reset();
    document.getElementById('invoice_id').value = '';
    
    // Clear line items
    document.getElementById('lineItems').innerHTML = '';
    lineItemCounter = 0;
    
    // Add initial line item
    addLineItem();
    
    document.getElementById('invoiceModal').classList.remove('hidden');
}

function editInvoice(invoiceId) {
    isEditing = true;
    document.getElementById('modal-title').textContent = 'Edit Invoice';
    document.getElementById('submit-text').textContent = 'Update Invoice';
    
    // Load invoice data
    fetch(`/sales/invoices/${invoiceId}/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const invoice = data.invoice;
            
            // Populate form fields
            document.getElementById('invoice_id').value = invoice.id;
            document.getElementById('customer_id').value = invoice.customer_id;
            document.getElementById('sales_order_id').value = invoice.sales_order_id || '';
            document.getElementById('invoice_date').value = invoice.invoice_date;
            document.getElementById('due_date').value = invoice.due_date;
            document.getElementById('currency_id').value = invoice.currency_id;
            document.getElementById('reference').value = invoice.reference || '';
            document.getElementById('terms_conditions').value = invoice.terms_conditions || '';
            
            // Clear and populate line items
            document.getElementById('lineItems').innerHTML = '';
            lineItemCounter = 0;
            
            if (invoice.line_items && invoice.line_items.length > 0) {
                invoice.line_items.forEach(item => {
                    addLineItem(item);
                });
            } else {
                addLineItem();
            }
            
            updateTotals();
            document.getElementById('invoiceModal').classList.remove('hidden');
        } else {
            alert('Error loading invoice: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error loading invoice');
    });
}

function closeInvoiceModal() {
    document.getElementById('invoiceModal').classList.add('hidden');
}

// Load products and taxes
function loadProducts() {
    fetch('/sales/products/', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            products = data.products;
        }
    })
    .catch(error => console.error('Error loading products:', error));
}

function loadTaxes() {
    fetch('/sales/taxes/', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            taxes = data.taxes;
        }
    })
    .catch(error => console.error('Error loading taxes:', error));
}

// Line item functions
function addLineItem(itemData = null) {
    lineItemCounter++;
    const lineItemsContainer = document.getElementById('lineItems');
    
    const lineItemHtml = `
        <div class="line-item p-4 border border-gray-200 rounded-lg" data-item-id="${lineItemCounter}">
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Product</label>
                    <select name="product_id_${lineItemCounter}" class="product-select w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" onchange="updateProductInfo(${lineItemCounter})">
                        <option value="">Select Product</option>
                        ${products.map(product => `<option value="${product.id}" ${itemData && itemData.product_id == product.id ? 'selected' : ''}>${product.name}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                    <input type="number" name="quantity_${lineItemCounter}" min="0" step="0.01" value="${itemData ? itemData.quantity : '1'}" 
                           class="quantity-input w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" 
                           onchange="calculateLineTotal(${lineItemCounter})">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Unit Price</label>
                    <input type="number" name="unit_price_${lineItemCounter}" min="0" step="0.01" value="${itemData ? itemData.unit_price : '0'}" 
                           class="unit-price-input w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" 
                           onchange="calculateLineTotal(${lineItemCounter})">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tax</label>
                    <select name="tax_id_${lineItemCounter}" class="tax-select w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" onchange="calculateLineTotal(${lineItemCounter})">
                        <option value="">No Tax</option>
                        ${taxes.map(tax => `<option value="${tax.id}" data-rate="${tax.rate}" ${itemData && itemData.tax_id == tax.id ? 'selected' : ''}>${tax.name} (${tax.rate}%)</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Total</label>
                    <div class="line-total font-medium text-gray-900 py-2">$0.00</div>
                </div>
                <div>
                    <button type="button" onclick="removeLineItem(${lineItemCounter})" 
                            class="w-full px-3 py-2 border border-red-300 rounded-md text-red-700 hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        Remove
                    </button>
                </div>
            </div>
        </div>
    `;
    
    lineItemsContainer.insertAdjacentHTML('beforeend', lineItemHtml);
    
    // Calculate totals for existing item
    if (itemData) {
        calculateLineTotal(lineItemCounter);
    }
    
    updateTotals();
}

function removeLineItem(itemId) {
    const lineItem = document.querySelector(`[data-item-id="${itemId}"]`);
    if (lineItem) {
        lineItem.remove();
        updateTotals();
    }
}

function updateProductInfo(itemId) {
    const productSelect = document.querySelector(`select[name="product_id_${itemId}"]`);
    const unitPriceInput = document.querySelector(`input[name="unit_price_${itemId}"]`);
    
    if (productSelect.value) {
        const product = products.find(p => p.id == productSelect.value);
        if (product) {
            unitPriceInput.value = product.unit_price || 0;
            calculateLineTotal(itemId);
        }
    }
}

function calculateLineTotal(itemId) {
    const quantityInput = document.querySelector(`input[name="quantity_${itemId}"]`);
    const unitPriceInput = document.querySelector(`input[name="unit_price_${itemId}"]`);
    const taxSelect = document.querySelector(`select[name="tax_id_${itemId}"]`);
    const totalDiv = document.querySelector(`[data-item-id="${itemId}"] .line-total`);
    
    const quantity = parseFloat(quantityInput.value) || 0;
    const unitPrice = parseFloat(unitPriceInput.value) || 0;
    const subtotal = quantity * unitPrice;
    
    let taxRate = 0;
    if (taxSelect.value) {
        const selectedOption = taxSelect.options[taxSelect.selectedIndex];
        taxRate = parseFloat(selectedOption.dataset.rate) || 0;
    }
    
    const taxAmount = subtotal * (taxRate / 100);
    const total = subtotal + taxAmount;
    
    totalDiv.textContent = `$${total.toFixed(2)}`;
    
    updateTotals();
}

function updateTotals() {
    let subtotal = 0;
    let totalTax = 0;
    
    document.querySelectorAll('.line-item').forEach(lineItem => {
        const itemId = lineItem.dataset.itemId;
        const quantity = parseFloat(document.querySelector(`input[name="quantity_${itemId}"]`).value) || 0;
        const unitPrice = parseFloat(document.querySelector(`input[name="unit_price_${itemId}"]`).value) || 0;
        const lineSubtotal = quantity * unitPrice;
        subtotal += lineSubtotal;
        
        const taxSelect = document.querySelector(`select[name="tax_id_${itemId}"]`);
        if (taxSelect.value) {
            const selectedOption = taxSelect.options[taxSelect.selectedIndex];
            const taxRate = parseFloat(selectedOption.dataset.rate) || 0;
            totalTax += lineSubtotal * (taxRate / 100);
        }
    });
    
    const total = subtotal + totalTax;
    
    document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('tax_amount').textContent = `$${totalTax.toFixed(2)}`;
    document.getElementById('total').textContent = `$${total.toFixed(2)}`;
}

// Form submission
document.getElementById('invoiceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const lineItems = [];
    
    // Collect line item data
    document.querySelectorAll('.line-item').forEach(lineItem => {
        const itemId = lineItem.dataset.itemId;
        const productId = document.querySelector(`select[name="product_id_${itemId}"]`).value;
        const quantity = document.querySelector(`input[name="quantity_${itemId}"]`).value;
        const unitPrice = document.querySelector(`input[name="unit_price_${itemId}"]`).value;
        const taxId = document.querySelector(`select[name="tax_id_${itemId}"]`).value;
        
        if (productId && quantity && unitPrice) {
            lineItems.push({
                product_id: productId,
                quantity: quantity,
                unit_price: unitPrice,
                tax_id: taxId || null
            });
        }
    });
    
    formData.append('line_items', JSON.stringify(lineItems));
    
    const url = isEditing ? `/sales/invoices/${document.getElementById('invoice_id').value}/edit/` : '/sales/invoices/add/';
    
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeInvoiceModal();
            location.reload();
        } else {
            alert('Error: ' + (data.message || 'Unknown error occurred'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving invoice');
    });
});

// Action functions
function sendInvoice(invoiceId) {
    if (confirm('Are you sure you want to send this invoice?')) {
        fetch(`/sales/invoices/${invoiceId}/send/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.message || 'Failed to send invoice'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error sending invoice');
        });
    }
}

function markPaid(invoiceId) {
    if (confirm('Are you sure you want to mark this invoice as paid?')) {
        fetch(`/sales/invoices/${invoiceId}/mark-paid/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.message || 'Failed to mark invoice as paid'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error marking invoice as paid');
        });
    }
}

function deleteInvoice(invoiceId, invoiceNumber) {
    if (confirm(`Are you sure you want to delete invoice ${invoiceNumber}? This action cannot be undone.`)) {
        fetch(`/sales/invoices/${invoiceId}/delete/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.message || 'Failed to delete invoice'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting invoice');
        });
    }
}

// Customer change handler to load sales orders
document.getElementById('customer_id').addEventListener('change', function() {
    const customerId = this.value;
    const salesOrderSelect = document.getElementById('sales_order_id');
    
    // Clear existing options except the first one
    salesOrderSelect.innerHTML = '<option value="">No Sales Order</option>';
    
    if (customerId) {
        // Load sales orders for the selected customer
        fetch(`/sales/sales-orders/?customer=${customerId}&status=confirmed`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.sales_orders) {
                data.sales_orders.forEach(order => {
                    const option = document.createElement('option');
                    option.value = order.id;
                    option.textContent = `${order.order_number} - ${order.currency_symbol}${order.total_amount}`;
                    salesOrderSelect.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error loading sales orders:', error));
    }
});
</script>
{% endblock %}
