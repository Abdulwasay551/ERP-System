{% extends 'base.html' %}
{% load static humanize %}
{% load sales_filters %}

{% block title %}Invoice #{{ invoice.invoice_number }} - {{ invoice.get_status_display }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header with Invoice Info -->
    <div class="bg-white dark:bg-green-900/20 rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Invoice #{{ invoice.invoice_number }}</h1>
                <div class="flex items-center mt-2">
                    <span class="px-3 py-1 text-sm rounded-full 
                        {% if invoice.status == 'paid' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                        {% elif invoice.status == 'partially_paid' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                        {% elif invoice.status == 'overdue' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200
                        {% else %}bg-gray-100 text-gray-800 dark:bg-green-700/20 dark:text-gray-300{% endif %}">
                        {{ invoice.get_status_display }}
                    </span>
                </div>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-500 dark:text-gray-400">Invoice Date</p>
                <p class="font-medium dark:text-gray-200">{{ invoice.invoice_date|date:"M d, Y" }}</p>
                {% if invoice.due_date %}
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Due Date</p>
                <p class="font-medium {% if invoice.status != 'paid' and invoice.is_overdue %}text-red-600 dark:text-red-400{% else %}dark:text-gray-200{% endif %}">
                    {{ invoice.due_date|date:"M d, Y" }}
                    {% if invoice.is_overdue %}
                        <span class="ml-1">(Overdue)</span>
                    {% endif %}
                </p>
                {% endif %}
            </div>
        </div>
        <!-- Action Buttons -->
        <div class="mt-4 flex justify-between items-center">
            <div class="space-x-3">
                {% if invoice.status == 'draft' %}
                <form method="post" action="{% url 'sales:invoices_send' invoice.id %}" class="inline">
                    {% csrf_token %}
                    <button @click="$dispatch('open-payment-modal')" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="-ml-0.5 mr-1.5 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Record Payment
                    </button>
                </form>
                {% endif %}
                <button @click="document.dispatchEvent(new CustomEvent('open-edit-modal'))" class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-green-700/20 dark:border-gray-600 dark:text-gray-200">
                    <svg class="-ml-0.5 mr-1.5 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Edit
                </button>
                <button onclick="window.print()" class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-green-700/20 dark:border-gray-600 dark:text-gray-200">
                    <svg class="-ml-0.5 mr-1.5 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                    </svg>
                    Print
                </button>
                <button @click="document.dispatchEvent(new CustomEvent('open-delete-modal'))" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    <svg class="-ml-0.5 mr-1.5 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Delete
                </button>
            </div>
            <a href="{% url 'sales:invoices' %}" class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-green-700/20 dark:border-gray-600 dark:text-gray-200">
                <svg class="-ml-0.5 mr-1.5 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to Invoices
            </a>
        </div>
    </div>

    <!-- Invoice Details -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <!-- Customer Information -->
        <div class="bg-white dark:bg-green-900/20 rounded-lg shadow-md p-6">
            <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Bill To</h3>
            <div class="mt-2">
                <p class="text-sm font-medium text-gray-900 dark:text-gray-200">{{ invoice.customer.name }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 whitespace-pre-line">{{ invoice.customer.billing_address|linebreaksbr }}</p>
                {% if invoice.customer.tax_id %}
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                    <span class="font-medium">Tax ID:</span> {{ invoice.customer.tax_id }}
                </p>
                {% endif %}
            </div>
        </div>

        <!-- Invoice Information -->
        <div class="bg-white dark:bg-green-900/20 rounded-lg shadow-md p-6">
            <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Invoice Information</h3>
            <dl class="mt-2 space-y-1">
                <div class="flex justify-between">
                    <dt class="text-sm text-gray-500 dark:text-gray-400">Invoice #</dt>
                    <dd class="text-sm text-gray-900 dark:text-gray-200">{{ invoice.invoice_number }}</dd>
                </div>
                <div class="flex justify-between">
                    <dt class="text-sm text-gray-500 dark:text-gray-400">Order #</dt>
                    <dd class="text-sm text-gray-900 dark:text-gray-200">{{ invoice.order_number|default:"-" }}</dd>
                </div>
                <div class="flex justify-between">
                    <dt class="text-sm text-gray-500 dark:text-gray-400">Reference</dt>
                    <dd class="text-sm text-gray-900 dark:text-gray-200">{{ invoice.reference|default:"-" }}</dd>
                </div>
            </dl>
        </div>

        <!-- Payment Information -->
        <div class="bg-white dark:bg-green-900/20 rounded-lg shadow-md p-6">
            <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Payment Information</h3>
            <dl class="mt-2 space-y-1">
                <div class="flex justify-between">
                    <dt class="text-sm text-gray-500 dark:text-gray-400">Subtotal</dt>
                    <dd class="text-sm text-gray-900 dark:text-gray-200">{{ invoice.subtotal|intcomma }}</dd>
                </div>
                {% if invoice.tax_amount > 0 %}
                <div class="flex justify-between">
                    <dt class="text-sm text-gray-500 dark:text-gray-400">Tax ({{ invoice.tax_rate }}%)</dt>
                    <dd class="text-sm text-gray-900 dark:text-gray-200">{{ invoice.tax_amount|intcomma }}</dd>
                </div>
                {% endif %}
                <div class="flex justify-between border-t border-gray-200 dark:border-gray-700 pt-2 mt-2">
                    <dt class="text-sm font-medium text-gray-700 dark:text-gray-300">Total</dt>
                    <dd class="text-sm font-medium text-gray-900 dark:text-white">{{ invoice.total|intcomma }}</dd>
                </div>
                <div class="flex justify-between">
                    <dt class="text-sm text-gray-500 dark:text-gray-400">Amount Paid</dt>
                    <dd class="text-sm text-gray-900 dark:text-gray-200">{{ invoice.amount_paid|intcomma|default:"0.00" }}</dd>
                </div>
                <div class="flex justify-between border-t border-gray-200 dark:border-gray-700 pt-2 mt-2">
                    <dt class="text-sm font-medium text-gray-700 dark:text-gray-300">Balance Due</dt>
                    <dd class="text-sm font-medium {% if invoice.balance_due > 0 %}text-red-600 dark:text-red-400{% else %}text-green-600 dark:text-green-400{% endif %}">
                        {{ invoice.balance_due|intcomma }}
                    </dd>
                </div>
            </dl>
        </div>
    </div>

    <!-- Line Items -->
    <div class="bg-white dark:bg-green-900/20 rounded-lg shadow-md overflow-hidden mb-6">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-lg font-medium text-gray-900 dark:text-gray-100">Invoice Items</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-green-700/20">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">#</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Item</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Quantity</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Unit Price</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tax</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Amount</th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-green-900/20 divide-y divide-gray-200 dark:divide-gray-700">
                    {% for item in items %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">{{ forloop.counter }}</td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900 dark:text-gray-200">
                                {{ item.product.name|default:item.description }}
                            </div>
                            {% if item.description %}
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                {{ item.description }}
                            </div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500 dark:text-gray-300">
                            {{ item.quantity|floatformat:2 }} {{ item.uom|default:"Unit" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900 dark:text-gray-200">
                            {{ item.unit_price|intcomma }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500 dark:text-gray-300">
                            {% if item.tax %}
                                {{ item.tax.rate }}% ({{ item.tax_amount|intcomma }})
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-right text-gray-900 dark:text-white">
                            {{ item.total|intcomma }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Notes and Related Documents -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Notes -->
        {% if invoice.notes %}
        <div class="md:col-span-2">
            <div class="bg-white dark:bg-green-900/20 rounded-lg shadow-md p-6">
                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Notes</h3>
                <div class="prose prose-sm max-w-none text-gray-500 dark:text-gray-300">
                    {{ invoice.notes|linebreaksbr }}
                </div>
            </div>
        </div>
        {% endif %}        
        <!-- Related Documents -->
        <div class="{% if invoice.notes %}{% else %}md:col-span-3{% endif %}">
            <div class="bg-white dark:bg-green-900/20 rounded-lg shadow-md p-6">
                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-4">Related Documents</h3>
                <div class="space-y-4">
                    {% if invoice.sales_order %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-green-800/20 rounded-lg">
                        <div class="flex items-center">
                            <div class="p-2 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900 dark:text-gray-200">Sales Order</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">#{{ invoice.sales_order.order_number }}</p>
                            </div>
                        </div>
                        <a href="{% url 'sales:sales_orders_detail' invoice.sales_order.id %}" 
                           class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-blue-900/30 dark:text-blue-300 dark:hover:bg-blue-900/40">
                            View
                        </a>
                    </div>
                    {% endif %}
                    
                    {% if invoice.delivery_notes.exists %}
                        {% for note in invoice.delivery_notes.all %}
                        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-green-800/20 rounded-lg">
                            <div class="flex items-center">
                                <div class="p-2 rounded-full bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-900 dark:text-gray-200">Delivery Note #{{ note.delivery_note_number }}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">{{ note.delivery_date|date:"M d, Y" }}</p>
                                </div>
                            </div>
                            <a href="{% url 'sales:delivery_note_detail' note.id %}" 
                               class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:bg-green-900/30 dark:text-green-300 dark:hover:bg-green-900/40">
                                View
                            </a>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Payment Modal -->
<div x-data="paymentModal" 
     x-init="init()"
     @keydown.escape.window="close()"
     @click.away="close"
     class="fixed inset-0 z-50 overflow-y-auto"
     x-cloak
     style="display: none;">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div x-show="show" 
             x-transition:enter="ease-out duration-300" 
             x-transition:enter-start="opacity-0" 
             x-transition:enter-end="opacity-100" 
             x-transition:leave="ease-in duration-200" 
             x-transition:leave-start="opacity-100" 
             x-transition:leave-end="opacity-0" 
             class="fixed inset-0 transition-opacity"
             @click="close()">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>

        <!-- Modal panel -->
        <div x-show="show" 
             x-transition:enter="ease-out duration-300" 
             x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
             x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" 
             x-transition:leave="ease-in duration-200" 
             x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" 
             x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
             class="inline-block w-full max-w-md p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-white rounded-lg shadow-xl dark:bg-gray-800"
             role="dialog" 
             aria-modal="true" 
             aria-labelledby="modal-headline"
             @click.away="close()">
            
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-gray-100" id="modal-headline">
                    Record Payment
                </h3>
                <button @click="close()" type="button" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                    <span class="sr-only">Close</span>
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <form method="post" action="{% url 'sales:invoice_record_payment' invoice.id %}" class="space-y-4">
                {% csrf_token %}
                
                <!-- Amount -->
                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Amount
                    </label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 sm:text-sm">{{ currency_symbol }}</span>
                        </div>
                        <input type="number" 
                               id="amount" 
                               name="amount" 
                               x-model="amount"
                               step="0.01" 
                               min="0.01" 
                               max="{{ invoice.balance_due }}"
                               class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-7 pr-12 sm:text-sm border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                               required>
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <span class="text-gray-500 sm:text-sm">
                                of {{ currency_symbol }}{{ invoice.balance_due|floatformat:2 }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Payment Date -->
                <div>
                    <label for="payment_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Payment Date
                    </label>
                    <div class="mt-1">
                        <input type="date" 
                               id="payment_date" 
                               name="payment_date" 
                               x-model="paymentDate"
                               class="focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                               required>
                    </div>
                </div>

                <!-- Payment Method -->
                <div>
                    <label for="payment_method" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Payment Method
                    </label>
                    <select id="payment_method" 
                            name="payment_method" 
                            x-model="paymentMethod"
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                            required>
                        {% for value, label in payment_methods %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Reference -->
                <div>
                    <label for="reference" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Reference
                    </label>
                    <div class="mt-1">
                        <input type="text" 
                               id="reference" 
                               name="reference" 
                               x-model="reference"
                               placeholder="Check #, Transaction ID, etc."
                               class="focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Notes
                    </label>
                    <div class="mt-1">
                        <textarea id="notes" 
                                 name="notes" 
                                 x-model="notes"
                                 rows="3" 
                                 class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"></textarea>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                    <button type="button" 
                            @click="close()"
                            class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:col-start-1 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-gray-600">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:col-start-2 sm:text-sm">
                        Record Payment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Invoice Modal -->
<div x-data="editModal"
     x-init="init()"
     @keydown.escape.window="close()"
     @click.away="close"
     class="fixed inset-0 z-50 overflow-y-auto"
     x-cloak
     style="display: none;">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div x-show="show" 
             x-transition:enter="ease-out duration-300" 
             x-transition:enter-start="opacity-0" 
             x-transition:enter-end="opacity-100" 
             x-transition:leave="ease-in duration-200" 
             x-transition:leave-start="opacity-100" 
             x-transition:leave-end="opacity-0" 
             class="fixed inset-0 transition-opacity"
             aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 dark:bg-gray-900 opacity-75"></div>
        </div>

        <!-- Modal panel -->
        <div x-show="show" 
             x-transition:enter="ease-out duration-300" 
             x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
             x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" 
             x-transition:leave="ease-in duration-200" 
             x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" 
             x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
             class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full sm:p-6"
             role="dialog" 
             aria-modal="true" 
             aria-labelledby="modal-headline">
            <div class="hidden sm:block absolute top-0 right-0 pt-4 pr-4">
                <button type="button" 
                        @click="close()"
                        class="text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <span class="sr-only">Close</span>
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="sm:flex sm:items-start">
                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                    <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                </div>
                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100" id="modal-headline">
                        Edit Invoice #{{ invoice.invoice_number }}
                    </h3>
                    <div class="mt-2">
                        <form id="invoice-edit-form" method="post" action="{% url 'sales:invoices_edit_form' invoice.id %}" class="space-y-4">
                            {% csrf_token %}
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="invoice_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Invoice Date *</label>
                                    <input type="date" id="invoice_date" name="invoice_date" value="{{ invoice.invoice_date|date:'Y-m-d' }}" required
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                </div>
                                <div>
                                    <label for="due_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Due Date *</label>
                                    <input type="date" id="due_date" name="due_date" value="{{ invoice.due_date|date:'Y-m-d' }}" required
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                </div>
                            </div>
                            
                            <div>
                                <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Status</label>
                                <select id="status" name="status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <option value="draft" {% if invoice.status == 'draft' %}selected{% endif %}>Draft</option>
                                    <option value="sent" {% if invoice.status == 'sent' %}selected{% endif %}>Sent</option>
                                    <option value="paid" {% if invoice.status == 'paid' %}selected{% endif %}>Paid</option>
                                    <option value="overdue" {% if invoice.status == 'overdue' %}selected{% endif %}>Overdue</option>
                                    <option value="cancelled" {% if invoice.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Notes</label>
                                <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">{{ invoice.notes|default:'' }}</textarea>
                            </div>
                            
                            <div>
                                <label for="terms" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Terms & Conditions</label>
                                <textarea id="terms" name="terms" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">{{ invoice.terms|default:'' }}</textarea>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                <button type="submit" 
                        form="invoice-edit-form"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Save Changes
                </button>
                <button type="button" 
                        @click="close()"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:w-auto sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:bg-gray-600">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div x-data="deleteModal"
     x-init="init()"
     @keydown.escape.window="close()"
     @click.away="close"
     class="fixed inset-0 z-50 overflow-y-auto"
     x-cloak
     style="display: none;">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div x-show="show" 
             x-transition:enter="ease-out duration-300" 
             x-transition:enter-start="opacity-0" 
             x-transition:enter-end="opacity-100" 
             x-transition:leave="ease-in duration-200" 
             x-transition:leave-start="opacity-100" 
             x-transition:leave-end="opacity-0" 
             class="fixed inset-0 transition-opacity"
             @click="close()">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>

        <!-- Modal panel -->
        <div x-show="show" 
             x-transition:enter="ease-out duration-300" 
             x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
             x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" 
             x-transition:leave="ease-in duration-200" 
             x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" 
             x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
             class="inline-block w-full max-w-md p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-white rounded-lg shadow-xl dark:bg-gray-800"
             role="dialog" 
             aria-modal="true" 
             aria-labelledby="delete-modal-title">
            
            <div class="sm:flex sm:items-start">
                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100" id="delete-modal-title">
                        Delete Invoice
                    </h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            Are you sure you want to delete this invoice? This action cannot be undone.
                        </p>
                        <p class="mt-2 text-sm text-red-600 dark:text-red-400">
                            Warning: This will permanently delete the invoice and all associated records.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                <form method="post" action="{% url 'sales:invoice_delete' invoice.id %}" class="sm:ml-3">
                    {% csrf_token %}
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Delete
                    </button>
                </form>
                <button @click="close()" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:w-auto sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Initialize Alpine.js components
    document.addEventListener('alpine:init', () => {
        // Auto-format amount field
        Alpine.data('formatAmount', () => ({
            init() {
                this.$el.addEventListener('input', (e) => {
                    // Format the input value as a currency
                    let value = e.target.value.replace(/[^\d.]/g, '');
                    value = parseFloat(value || 0).toFixed(2);
                    e.target.value = value;
                });
            }
        }));

        // Edit Invoice Modal Component
        Alpine.data('editModal', () => ({
            show: false,
            modalElement: null,
            invoiceId: null,
            loading: false,
            error: null,
            formData: {
                invoice_date: '',
                due_date: '',
                status: 'draft',
                notes: '',
                terms: ''
            },
            init() {
                this.modalElement = this.$el;
                this.invoiceId = '{{ invoice.id }}';
                
                // Listen for global open modal event
                const handleOpen = (e) => {
                    if (e.type === 'open-edit-modal') {
                        e.stopPropagation();
                        this.open();
                    }
                };
                
                // Add global event listener
                document.addEventListener('open-edit-modal', handleOpen);
                
                // Clean up event listener when component is destroyed
                this.$el._handleOpen = handleOpen;
                
                // Watch show state for transitions
                this.$watch('show', value => {
                    if (value) {
                        document.body.classList.add('overflow-hidden');
                        this.modalElement.style.display = 'block';
                        this.fetchInvoiceData();
                    } else {
                        document.body.classList.remove('overflow-hidden');
                        this.modalElement.style.display = 'none';
                    }
                });
                
                // Initialize form data
                this.initializeFormData();
            },
            initializeFormData() {
                // Initialize form data from template variables
                this.formData = {
                    invoice_date: '{{ invoice.invoice_date|date:"Y-m-d" }}',
                    due_date: '{{ invoice.due_date|date:"Y-m-d" }}',
                    status: '{{ invoice.status }}',
                    notes: '{{ invoice.notes|default:""|escapejs }}',
                    terms: '{{ invoice.terms|default:""|escapejs }}'
                };
            },
            async fetchInvoiceData() {
                try {
                    this.loading = true;
                    this.error = null;
                    
                    // Fetch the latest invoice data
                    const response = await fetch(`/sales/invoices/${this.invoiceId}/edit/`);
                    
                    if (!response.ok) {
                        throw new Error('Failed to fetch invoice data');
                    }
                    
                    const data = await response.json();
                    
                    // Update form data with fetched values
                    this.formData = {
                        invoice_date: data.invoice_date,
                        due_date: data.due_date,
                        status: data.status,
                        notes: data.notes || '',
                        terms: data.terms || ''
                    };
                    
                } catch (error) {
                    console.error('Error fetching invoice data:', error);
                    this.error = 'Failed to load invoice data. Please try again.';
                    // Fall back to template data if fetch fails
                    this.initializeFormData();
                } finally {
                    this.loading = false;
                }
            },
            open() {
                this.show = true;
                this.$nextTick(() => {
                    // Focus the first input field when modal opens
                    const firstInput = this.$el.querySelector('input, select, textarea');
                    if (firstInput) firstInput.focus();
                });
            },
            close() {
                if (this.show) {
                    this.show = false;
                }
            },
            handleSubmit(e) {
                e.preventDefault();
                this.saveChanges();
            },
            async saveChanges() {
                try {
                    this.loading = true;
                    this.error = null;
                    
                    const form = document.getElementById('invoice-edit-form');
                    const formData = new FormData(form);
                    
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                        },
                        body: formData
                    });
                    
                    if (response.redirected) {
                        // If the response is a redirect, follow it
                        window.location.href = response.url;
                        return;
                    }
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        // Success - reload the page to show updated data
                        window.location.reload();
                    } else {
                        // Handle validation errors
                        this.error = result.message || 'Failed to update invoice. Please check the form for errors.';
                    }
                    
                } catch (error) {
                    console.error('Error updating invoice:', error);
                    this.error = 'An error occurred while updating the invoice. Please try again.';
                } finally {
                    this.loading = false;
                }
            }
        }));

        // Payment Modal Component
        Alpine.data('paymentModal', () => ({
            show: false,
            amount: '{{ invoice.balance_due|floatformat:2 }}',
            paymentDate: '{% now "Y-m-d" %}',
            paymentMethod: '{{ payment_methods.0.0 }}',
            reference: '',
            notes: '',
            modalElement: null,
            init() {
                this.modalElement = this.$el;
                this.amount = parseFloat(this.amount).toFixed(2);
                this.$el.addEventListener('open-payment-modal', (e) => {
                    e.stopPropagation();
                    this.open();
                });
                this.$watch('show', value => {
                    if (value) {
                        document.body.classList.add('overflow-hidden');
                        this.modalElement.style.display = 'block';
                    } else {
                        document.body.classList.remove('overflow-hidden');
                        this.modalElement.style.display = 'none';
                    }
                });
            },
            open() {
                this.show = true;
                this.amount = parseFloat('{{ invoice.balance_due|floatformat:2 }}').toFixed(2);
                this.paymentDate = '{% now "Y-m-d" %}';
                this.paymentMethod = '{{ payment_methods.0.0 }}';
                this.reference = '';
                this.notes = '';
                this.$nextTick(() => {
                    const firstInput = this.$el.querySelector('input, select, textarea');
                    if (firstInput) firstInput.focus();
                });
            },
            close() {
                if (this.show) {
                    this.show = false;
                }
            },
            handleSubmit(e) {
                return true;
            }
        }));

        // Delete Confirmation Modal Component
        Alpine.data('deleteModal', () => ({
            show: false,
            modalElement: null,
            init() {
                this.modalElement = this.$el;
                
                // Listen for global open modal event
                const handleOpen = (e) => {
                    if (e.type === 'open-delete-modal') {
                        e.stopPropagation();
                        this.open();
                    }
                };
                
                // Add global event listener
                document.addEventListener('open-delete-modal', handleOpen);
                
                // Clean up event listener when component is destroyed
                this.$el._handleOpen = handleOpen;
                
                this.$watch('show', value => {
                    if (value) {
                        document.body.classList.add('overflow-hidden');
                        this.modalElement.style.display = 'block';
                    } else {
                        document.body.classList.remove('overflow-hidden');
                        this.modalElement.style.display = 'none';
                    }
                });
            },
            open() {
                this.show = true;
                this.$nextTick(() => {
                    const cancelBtn = this.$el.querySelector('button[type="button"]');
                    if (cancelBtn) cancelBtn.focus();
                });
            },
            close() {
                if (this.show) {
                    this.show = false;
                }
            }
        }));
    });

    // Close modals when clicking outside or pressing escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const modals = document.querySelectorAll('[x-data]');
            modals.forEach(modal => {
                const component = Alpine.$data(modal);
                if (component && component.close) {
                    component.close();
                }
            });
        }
    });
    
    // Initialize modals after page load
    document.addEventListener('alpine:init', () => {
        // Clean up event listeners when components are destroyed
        document.addEventListener('alpine:initialized', () => {
            const cleanup = (el) => {
                if (el._handleOpen) {
                    document.removeEventListener('open-edit-modal', el._handleOpen);
                    document.removeEventListener('open-delete-modal', el._handleOpen);
                }
            };
            
            // Set up mutation observer to clean up when components are removed
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.removedNodes.forEach((node) => {
                        if (node.nodeType === 1) { // Element node
                            if (node._x_dataStack) {
                                cleanup(node);
                            }
                            // Check children
                            node.querySelectorAll('[x-data]').forEach(cleanup);
                        }
                    });
                });
            });
            
            observer.observe(document.body, { childList: true, subtree: true });
        });
    });
</script>
{% endblock %}
