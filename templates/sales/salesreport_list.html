{% extends 'base.html' %}
{% load static %}
{% block title %}Sales Reports | ERP System{% endblock %}
{% block content %}
<div class="pt-24 pb-8">
    <!-- Header Section -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-3xl font-bold text-emerald-700">Sales Analytics & Reports</h2>
            <p class="text-emerald-600 mt-1">Comprehensive sales performance insights and analytics</p>
        </div>
        <div class="flex space-x-3">
            <button onclick="exportReport()" class="quick-action-btn bg-blue-600 hover:bg-blue-700">
                <i class="fas fa-download mr-2"></i>Export Report
            </button>
            <button onclick="printReport()" class="quick-action-btn bg-gray-600 hover:bg-gray-700">
                <i class="fas fa-print mr-2"></i>Print Report
            </button>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <h3 class="text-lg font-semibold text-emerald-700 mb-4">Report Filters</h3>
        <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label for="date_from" class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                <input type="date" id="date_from" name="date_from" value="{{ date_from }}"
                       class="w-full px-4 py-2 border border-emerald-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
            </div>
            <div>
                <label for="date_to" class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                <input type="date" id="date_to" name="date_to" value="{{ date_to }}"
                       class="w-full px-4 py-2 border border-emerald-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
            </div>
            <div>
                <label for="customer" class="block text-sm font-medium text-gray-700 mb-2">Customer</label>
                <select id="customer" name="customer"
                        class="w-full px-4 py-2 border border-emerald-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <option value="">All Customers</option>
                    {% for customer in customers %}
                    <option value="{{ customer.id }}" {% if current_customer == customer.id|stringformat:"s" %}selected{% endif %}>
                        {{ customer.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex items-end">
                <button type="submit" class="w-full quick-action-btn">
                    <i class="fas fa-filter mr-2"></i>Apply Filters
                </button>
            </div>
        </form>
    </div>

    <!-- Key Performance Indicators -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <div class="stat-card">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-emerald-100 text-emerald-600">
                    <i class="fas fa-file-alt text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total Quotations</p>
                    <p class="text-2xl font-bold text-emerald-700">{{ total_quotations }}</p>
                    <p class="text-sm text-gray-500">${{ total_quotation_value|floatformat:0 }}</p>
                </div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-shopping-cart text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Sales Orders</p>
                    <p class="text-2xl font-bold text-blue-700">{{ total_sales_orders }}</p>
                    <p class="text-sm text-gray-500">${{ total_sales_value|floatformat:0 }}</p>
                </div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fas fa-file-invoice-dollar text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Invoices</p>
                    <p class="text-2xl font-bold text-green-700">{{ total_invoices }}</p>
                    <p class="text-sm text-gray-500">${{ total_invoice_value|floatformat:0 }}</p>
                </div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <i class="fas fa-money-bill-wave text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Collections</p>
                    <p class="text-2xl font-bold text-purple-700">${{ total_paid_amount|floatformat:0 }}</p>
                    <p class="text-sm text-gray-500">{{ payment_collection_rate|floatformat:1 }}% rate</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Conversion Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="stat-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Quote to Order Rate</p>
                    <p class="text-3xl font-bold text-emerald-700">{{ quotation_to_order_rate|floatformat:1 }}%</p>
                </div>
                <div class="p-3 rounded-full bg-emerald-100 text-emerald-600">
                    <i class="fas fa-exchange-alt text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Order to Invoice Rate</p>
                    <p class="text-3xl font-bold text-blue-700">{{ order_to_invoice_rate|floatformat:1 }}%</p>
                </div>
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-chart-line text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Payment Collection Rate</p>
                    <p class="text-3xl font-bold text-green-700">{{ payment_collection_rate|floatformat:1 }}%</p>
                </div>
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fas fa-percent text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Outstanding & Overdue -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center mb-4">
                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 mr-4">
                    <i class="fas fa-clock text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Outstanding Receivables</h3>
                    <p class="text-3xl font-bold text-yellow-600">${{ outstanding_invoices|floatformat:0 }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center mb-4">
                <div class="p-3 rounded-full bg-red-100 text-red-600 mr-4">
                    <i class="fas fa-exclamation-triangle text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Overdue Amounts</h3>
                    <p class="text-3xl font-bold text-red-600">${{ overdue_invoices|floatformat:0 }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Analytics -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Monthly Sales Trend -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-emerald-700 mb-4">Monthly Sales Trend</h3>
            <div class="h-64">
                <canvas id="salesTrendChart"></canvas>
            </div>
        </div>
        
        <!-- Status Breakdown -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-emerald-700 mb-4">Sales Pipeline Status</h3>
            <div class="space-y-4">
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">Quotations</h4>
                    {% for status, count in quotation_status_breakdown.items %}
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm text-gray-600">{{ status }}</span>
                        <span class="text-sm font-medium">{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="border-t pt-4">
                    <h4 class="font-medium text-gray-700 mb-2">Sales Orders</h4>
                    {% for status, count in sales_order_status_breakdown.items %}
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm text-gray-600">{{ status }}</span>
                        <span class="text-sm font-medium">{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Top Performers -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Top Customers -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-emerald-700 mb-4">Top Customers</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider py-2">Customer</th>
                            <th class="text-right text-xs font-medium text-gray-500 uppercase tracking-wider py-2">Sales</th>
                            <th class="text-right text-xs font-medium text-gray-500 uppercase tracking-wider py-2">Orders</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for customer in top_customers %}
                        <tr>
                            <td class="py-2">
                                <div class="text-sm font-medium text-gray-900">{{ customer.name }}</div>
                            </td>
                            <td class="py-2 text-right">
                                <div class="text-sm font-medium text-gray-900">${{ customer.total_sales|floatformat:0 }}</div>
                            </td>
                            <td class="py-2 text-right">
                                <div class="text-sm text-gray-500">{{ customer.total_orders }}</div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="py-4 text-center text-gray-500">No data available</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Top Products -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-emerald-700 mb-4">Top Products</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider py-2">Product</th>
                            <th class="text-right text-xs font-medium text-gray-500 uppercase tracking-wider py-2">Sales</th>
                            <th class="text-right text-xs font-medium text-gray-500 uppercase tracking-wider py-2">Orders</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for product in top_products %}
                        <tr>
                            <td class="py-2">
                                <div class="text-sm font-medium text-gray-900">{{ product.name }}</div>
                            </td>
                            <td class="py-2 text-right">
                                <div class="text-sm font-medium text-gray-900">${{ product.total_sold|floatformat:0 }}</div>
                            </td>
                            <td class="py-2 text-right">
                                <div class="text-sm text-gray-500">{{ product.order_count }}</div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="py-4 text-center text-gray-500">No data available</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Detailed Data Tables -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-emerald-700">Detailed Analytics</h3>
            <div class="flex space-x-2">
                <button onclick="showTable('quotations')" id="quotationsTab" class="tab-btn active">Quotations</button>
                <button onclick="showTable('orders')" id="ordersTab" class="tab-btn">Orders</button>
                <button onclick="showTable('invoices')" id="invoicesTab" class="tab-btn">Invoices</button>
            </div>
        </div>
        
        <div id="quotationsTable" class="table-content">
            <p class="text-gray-600">Detailed quotation analytics for the selected period...</p>
        </div>
        
        <div id="ordersTable" class="table-content hidden">
            <p class="text-gray-600">Detailed sales order analytics for the selected period...</p>
        </div>
        
        <div id="invoicesTable" class="table-content hidden">
            <p class="text-gray-600">Detailed invoice analytics for the selected period...</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Sales Trend Chart
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('salesTrendChart').getContext('2d');
    const monthlyData = {{ monthly_sales|safe }};
    
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: monthlyData.map(item => item.month),
            datasets: [{
                label: 'Sales Value',
                data: monthlyData.map(item => item.sales),
                borderColor: 'rgb(34, 197, 94)',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                tension: 0.1,
                yAxisID: 'y'
            }, {
                label: 'Quotations',
                data: monthlyData.map(item => item.quotes),
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.1,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Month'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Sales Value ($)'
                    },
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Quotations Count'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
});

// Tab functionality
function showTable(tableType) {
    // Hide all tables
    document.querySelectorAll('.table-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected table and activate tab
    document.getElementById(tableType + 'Table').classList.remove('hidden');
    document.getElementById(tableType + 'Tab').classList.add('active');
}

// Export and Print functions
function exportReport() {
    const reportData = {
        dateFrom: '{{ date_from }}',
        dateTo: '{{ date_to }}',
        totalQuotations: {{ total_quotations }},
        totalSalesValue: {{ total_sales_value }},
        totalInvoiceValue: {{ total_invoice_value }},
        conversionRate: {{ quotation_to_order_rate }}
    };
    
    // Create CSV content
    let csvContent = "Sales Report\n";
    csvContent += `Period: ${reportData.dateFrom} to ${reportData.dateTo}\n\n`;
    csvContent += "Key Metrics:\n";
    csvContent += `Total Quotations,${reportData.totalQuotations}\n`;
    csvContent += `Total Sales Value,${reportData.totalSalesValue}\n`;
    csvContent += `Total Invoice Value,${reportData.totalInvoiceValue}\n`;
    csvContent += `Conversion Rate,${reportData.conversionRate}%\n`;
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `sales_report_${reportData.dateFrom}_to_${reportData.dateTo}.csv`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
}

function printReport() {
    window.print();
}
</script>

<style>
.tab-btn {
    @apply px-4 py-2 text-sm font-medium text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors;
}

.tab-btn.active {
    @apply bg-emerald-600 text-white border-emerald-600;
}

@media print {
    .no-print {
        display: none !important;
    }
}
</style>
{% endblock %}
