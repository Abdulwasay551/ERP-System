{% extends 'base.html' %}
{% load static %}
{% block title %}Price Lists | ERP System{% endblock %}
{% block content %}
<div class="pt-24 pb-8">
    <!-- Header Section -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-3xl font-bold text-purple-700">Price List Management</h2>
            <p class="text-purple-600 mt-1">Manage product pricing for different customer groups and regions</p>
        </div>
        <button id="addPriceListBtn" class="quick-action-btn">
            <i class="fas fa-tags mr-2"></i>Add Price List
        </button>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="stat-card">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <i class="fas fa-tags text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total Price Lists</p>
                    <p class="text-2xl font-bold text-purple-700">{{ total_price_lists }}</p>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fas fa-check-circle text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Active Lists</p>
                    <p class="text-2xl font-bold text-green-700">{{ active_price_lists }}</p>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                    <i class="fas fa-star text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Default List</p>
                    <p class="text-2xl font-bold text-yellow-700">{{ default_price_list.name|default:"None"|truncatechars:10 }}</p>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-list text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total Items</p>
                    <p class="text-2xl font-bold text-blue-700">{{ total_items }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Price List Integration Notice -->
    <div class="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-xl p-6 mb-6">
        <div class="flex items-center">
            <i class="fas fa-handshake text-purple-600 mr-3"></i>
            <div>
                <h4 class="font-semibold text-purple-700">Customer & Currency Integration</h4>
                <p class="text-sm text-purple-600">Price lists can be assigned to specific customer groups and support multi-currency pricing. Automatically applied to quotations and sales orders.</p>
            </div>
        </div>
    </div>

    <!-- Price Lists Table -->
    <div class="bg-white rounded-xl shadow-lg p-6 accounting-highlight">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-purple-700">Price List Directory</h3>
            <div class="flex space-x-3">
                <input type="text" id="searchInput" placeholder="Search price lists..." 
                       class="px-4 py-2 border border-purple-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                <select id="statusFilter" class="px-4 py-2 border border-purple-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="">All Status</option>
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-purple-200">
                <thead class="bg-purple-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Price List</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Currency</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Valid Period</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Items</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-purple-700 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-purple-100">
                    {% for price_list in price_lists %}
                    <tr class="hover:bg-purple-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full bg-purple-100 flex items-center justify-center">
                                        <i class="fas fa-tags text-purple-600"></i>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">{{ price_list.name }}</div>
                                    <div class="text-sm text-gray-500">{{ price_list.description|truncatechars:40|default:"—" }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <span class="text-sm font-bold text-purple-600">{{ price_list.currency.code }}</span>
                                <span class="text-sm text-gray-500 ml-2">{{ price_list.currency.symbol }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if price_list.valid_from or price_list.valid_until %}
                                <div class="text-sm text-gray-900">
                                    {{ price_list.valid_from|date:"M d, Y"|default:"—" }} - 
                                    {{ price_list.valid_until|date:"M d, Y"|default:"Ongoing" }}
                                </div>
                            {% else %}
                                <span class="text-sm text-gray-400">No restrictions</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                {{ price_list.items.count }} items
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if price_list.is_default %}
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                    <i class="fas fa-star mr-1"></i>Default
                                </span>
                            {% else %}
                                <span class="text-sm text-gray-600">Standard</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if price_list.is_active %}
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                    Active
                                </span>
                            {% else %}
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                                    Inactive
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewPriceList({{ price_list.id }})" 
                                    class="text-purple-600 hover:text-purple-900 mr-3" title="View Items">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editPriceList({{ price_list.id }})" 
                                    class="text-purple-600 hover:text-purple-900 mr-3" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="copyPriceList({{ price_list.id }})" 
                                    class="text-blue-600 hover:text-blue-900 mr-3" title="Copy">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button onclick="deletePriceList({{ price_list.id }})" 
                                    class="text-red-600 hover:text-red-900" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            <div class="flex flex-col items-center py-12">
                                <i class="fas fa-tags text-4xl text-gray-300 mb-4"></i>
                                <p class="text-lg font-medium text-gray-500">No price lists configured</p>
                                <p class="text-sm text-gray-400">Add your first price list to get started</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Enhanced Modal for Add/Edit Price List -->
<div id="priceListModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-2xl relative transform transition-all">
        <button id="closePriceListModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 text-2xl">
            <i class="fas fa-times"></i>
        </button>
        
        <h3 id="priceListModalTitle" class="text-2xl font-bold text-purple-700 mb-6">
            <i class="fas fa-tags mr-2"></i>Add Price List
        </h3>
        
        <form id="priceListForm" class="space-y-6">
            {% csrf_token %}
            <input type="hidden" id="priceListId" name="id">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="pricelist_name" class="block text-sm font-medium text-gray-700 mb-2">
                        Price List Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="pricelist_name" name="name" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                           placeholder="e.g., Retail Prices, Wholesale Prices">
                </div>
                
                <div>
                    <label for="pricelist_currency" class="block text-sm font-medium text-gray-700 mb-2">
                        Currency <span class="text-red-500">*</span>
                    </label>
                    <select id="pricelist_currency" name="currency_id" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        <option value="">Select Currency</option>
                        {% for currency in currencies %}
                        <option value="{{ currency.id }}">{{ currency.code }} - {{ currency.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="pricelist_valid_from" class="block text-sm font-medium text-gray-700 mb-2">Valid From</label>
                    <input type="date" id="pricelist_valid_from" name="valid_from"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                </div>
                
                <div>
                    <label for="pricelist_valid_until" class="block text-sm font-medium text-gray-700 mb-2">Valid Until</label>
                    <input type="date" id="pricelist_valid_until" name="valid_until"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                </div>
            </div>
            
            <div>
                <label for="pricelist_description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                <textarea id="pricelist_description" name="description" rows="3"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                          placeholder="Brief description of this price list..."></textarea>
            </div>
            
            <div class="flex items-center space-x-6 pt-4">
                <label class="flex items-center">
                    <input type="checkbox" id="pricelist_is_active" name="is_active" checked
                           class="rounded border-gray-300 text-purple-600 shadow-sm focus:border-purple-300 focus:ring focus:ring-purple-200 focus:ring-opacity-50">
                    <span class="ml-2 text-sm font-medium text-gray-700">Active</span>
                </label>
                
                <label class="flex items-center">
                    <input type="checkbox" id="pricelist_is_default" name="is_default"
                           class="rounded border-gray-300 text-purple-600 shadow-sm focus:border-purple-300 focus:ring focus:ring-purple-200 focus:ring-opacity-50">
                    <span class="ml-2 text-sm font-medium text-gray-700">Default Price List</span>
                </label>
            </div>
            
            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                <button type="button" id="cancelPriceListBtn" 
                        class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button type="submit" 
                        class="quick-action-btn">
                    <i class="fas fa-save mr-2"></i>Save Price List
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Enhanced Price List Management
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('priceListModal');
    const addBtn = document.getElementById('addPriceListBtn');
    const closeModalBtn = document.getElementById('closePriceListModalBtn');
    const cancelBtn = document.getElementById('cancelPriceListBtn');
    const form = document.getElementById('priceListForm');
    const modalTitle = document.getElementById('priceListModalTitle');
    const priceListIdInput = document.getElementById('priceListId');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');

    // Modal functions
    function showModal(edit = false, data = {}) {
        modal.classList.remove('hidden');
        modalTitle.innerHTML = edit ? '<i class="fas fa-edit mr-2"></i>Edit Price List' : '<i class="fas fa-tags mr-2"></i>Add Price List';
        form.reset();
        
        if (edit && data) {
            priceListIdInput.value = data.id || '';
            document.getElementById('pricelist_name').value = data.name || '';
            document.getElementById('pricelist_currency').value = data.currency_id || '';
            document.getElementById('pricelist_valid_from').value = data.valid_from || '';
            document.getElementById('pricelist_valid_until').value = data.valid_until || '';
            document.getElementById('pricelist_description').value = data.description || '';
            document.getElementById('pricelist_is_active').checked = data.is_active !== false;
            document.getElementById('pricelist_is_default').checked = data.is_default === true;
        } else {
            // Set defaults for new price list
            document.getElementById('pricelist_is_active').checked = true;
            document.getElementById('pricelist_is_default').checked = false;
        }
    }

    function hideModal() {
        modal.classList.add('hidden');
    }

    // Event listeners
    addBtn.addEventListener('click', () => showModal(false));
    closeModalBtn.addEventListener('click', hideModal);
    cancelBtn.addEventListener('click', hideModal);
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) hideModal();
    });

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const isEdit = priceListIdInput.value !== '';
        const url = isEdit ? `/sales/price-lists/${priceListIdInput.value}/update/` : '/sales/price-lists/create/';
        
        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                hideModal();
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to save price list'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the price list');
        });
    });

    // Search and filter functionality
    if (searchInput) {
        searchInput.addEventListener('input', filterTable);
    }
    if (statusFilter) {
        statusFilter.addEventListener('change', filterTable);
    }

    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;
        const rows = document.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            if (row.querySelector('td:first-child')) {
                const priceListName = row.querySelector('td:first-child .text-sm.font-medium')?.textContent.toLowerCase() || '';
                const currency = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
                const status = row.querySelector('.inline-flex')?.textContent.toLowerCase().includes('active');
                
                const matchesSearch = priceListName.includes(searchTerm) || currency.includes(searchTerm);
                const matchesStatus = statusValue === '' || 
                                      (statusValue === 'true' && status) || 
                                      (statusValue === 'false' && !status);
                
                row.style.display = matchesSearch && matchesStatus ? '' : 'none';
            }
        });
    }

    // Date validation
    const validFromInput = document.getElementById('pricelist_valid_from');
    const validUntilInput = document.getElementById('pricelist_valid_until');
    
    validFromInput.addEventListener('change', function() {
        if (this.value && validUntilInput.value && this.value > validUntilInput.value) {
            validUntilInput.value = '';
            alert('Valid until date must be after valid from date');
        }
    });
    
    validUntilInput.addEventListener('change', function() {
        if (this.value && validFromInput.value && this.value < validFromInput.value) {
            this.value = '';
            alert('Valid until date must be after valid from date');
        }
    });
});

// Global functions
window.viewPriceList = function(priceListId) {
    window.open(`/sales/price-lists/${priceListId}/items/`, '_blank');
};

window.editPriceList = function(priceListId) {
    fetch(`/sales/price-lists/${priceListId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show modal with data
                document.getElementById('priceListModal').classList.remove('hidden');
                document.getElementById('priceListModalTitle').innerHTML = '<i class="fas fa-edit mr-2"></i>Edit Price List';
                document.getElementById('priceListId').value = data.price_list.id;
                document.getElementById('pricelist_name').value = data.price_list.name;
                document.getElementById('pricelist_currency').value = data.price_list.currency_id;
                document.getElementById('pricelist_valid_from').value = data.price_list.valid_from;
                document.getElementById('pricelist_valid_until').value = data.price_list.valid_until;
                document.getElementById('pricelist_description').value = data.price_list.description;
                document.getElementById('pricelist_is_active').checked = data.price_list.is_active;
                document.getElementById('pricelist_is_default').checked = data.price_list.is_default;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load price list data');
        });
};

window.copyPriceList = function(priceListId) {
    if (confirm('Create a copy of this price list?')) {
        fetch(`/sales/price-lists/${priceListId}/copy/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to copy price list'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while copying the price list');
        });
    }
};

window.deletePriceList = function(priceListId) {
    if (!confirm('Are you sure you want to delete this price list? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/sales/price-lists/${priceListId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete price list'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the price list');
    });
};
</script>
{% endblock %}
