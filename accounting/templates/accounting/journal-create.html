{% extends 'base.html' %}
{% load static %}

{% block title %}Create Journal Entry | FutureERP{% endblock %}

{% block extra_css %}
<style>
    .journal-card {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 95, 70, 0.1));
        border: 1px solid rgba(16, 185, 129, 0.2);
    }
    .entry-row {
        background: rgba(255, 255, 255, 0.7);
        transition: all 0.3s ease;
    }
    .entry-row:hover {
        background: rgba(59, 130, 246, 0.05);
    }
    .debit-input {
        border-left: 4px solid #10B981;
    }
    .credit-input {
        border-left: 4px solid #EF4444;
    }
    .balance-indicator {
        transition: all 0.3s ease;
    }
    .balanced {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 95, 70, 0.1));
        border: 2px solid #10B981;
    }
    .unbalanced {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(185, 28, 28, 0.1));
        border: 2px solid #EF4444;
    }
</style>
{% endblock %}

{% block content %}
<div class="pt-24 pb-8">
    <div class="mx-auto px-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-bold accounting-highlight mb-2">Create Journal Entry</h1>
                <p class="text-gray-600">Record financial transactions with proper debits and credits</p>
            </div>
            <div class="flex gap-4">
                <a href="{% url 'accounting:journal_entries' %}" class="action-btn bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-2xl hover-lift">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Journal
                </a>
            </div>
        </div>

        <div class="max-w-6xl mx-auto">
            <form id="journalForm" method="post">
                {% csrf_token %}
                
                <!-- Journal Header -->
                <div class="journal-card rounded-2xl p-6 mb-8">
                    <h3 class="text-xl font-bold text-gray-900 mb-6">Journal Entry Details</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Entry Date</label>
                            <input type="date" name="date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="{{ 'now'|date:'Y-m-d' }}" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Reference Number</label>
                            <input type="text" name="reference" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="JE-{{ 'now'|date:'Ymd' }}-001">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Entry Type</label>
                            <select name="entry_type" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="manual">Manual Entry</option>
                                <option value="adjusting">Adjusting Entry</option>
                                <option value="closing">Closing Entry</option>
                                <option value="reversing">Reversing Entry</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea name="description" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter a detailed description of this journal entry..."></textarea>
                    </div>
                </div>

                <!-- Journal Entry Lines -->
                <div class="journal-card rounded-2xl p-6 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Journal Entry Lines</h3>
                        <button type="button" id="addLineBtn" class="action-btn bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg hover-lift">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add Line
                        </button>
                    </div>

                    <!-- Entry Lines Header -->
                    <div class="grid grid-cols-12 gap-4 mb-4 text-sm font-medium text-gray-700 border-b border-gray-200 pb-3">
                        <div class="col-span-4">Account</div>
                        <div class="col-span-3">Description</div>
                        <div class="col-span-2">Debit</div>
                        <div class="col-span-2">Credit</div>
                        <div class="col-span-1">Action</div>
                    </div>

                    <!-- Entry Lines Container -->
                    <div id="entryLines" class="space-y-3">
                        <!-- Initial empty lines will be added here by JavaScript -->
                    </div>

                    <!-- Balance Check -->
                    <div id="balanceCheck" class="mt-6 p-4 rounded-lg unbalanced">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <svg id="balanceIcon" class="w-6 h-6 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span id="balanceText" class="font-semibold text-red-600">Entry is not balanced</span>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-600">
                                    Total Debits: $<span id="totalDebits">0.00</span> | 
                                    Total Credits: $<span id="totalCredits">0.00</span>
                                </div>
                                <div class="font-semibold text-lg">
                                    Difference: $<span id="difference">0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-between items-center">
                    <div class="flex gap-4">
                        <button type="button" class="action-btn bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-6 py-3 rounded-2xl hover-lift">
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            Save as Draft
                        </button>
                    </div>
                    
                    <div class="flex gap-4">
                        <button type="button" class="action-btn bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-2xl hover-lift">
                            Clear Form
                        </button>
                        <button type="submit" id="submitBtn" class="action-btn bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-2xl hover-lift" disabled>
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Post Journal Entry
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Account Selection Modal -->
<div id="accountModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-96 overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">Select Account</h3>
                    <button type="button" id="closeModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <input type="text" id="accountSearch" class="w-full mt-4 px-4 py-2 border border-gray-300 rounded-lg" placeholder="Search accounts...">
            </div>
            <div id="accountList" class="p-6 overflow-y-auto max-h-80">
                <!-- Account list will be populated here -->
            </div>
        </div>
    </div>
</div>

<script>
let lineCounter = 0;
let currentLineIndex = null;

// Sample account data - in a real app, this would come from an API
const accounts = [
    { id: 1, code: '1001', name: 'Cash', type: 'Asset' },
    { id: 2, code: '1200', name: 'Accounts Receivable', type: 'Asset' },
    { id: 3, code: '2001', name: 'Accounts Payable', type: 'Liability' },
    { id: 4, code: '3001', name: 'Owner\'s Equity', type: 'Equity' },
    { id: 5, code: '4001', name: 'Sales Revenue', type: 'Income' },
    { id: 6, code: '5001', name: 'Office Supplies Expense', type: 'Expense' }
];

document.addEventListener('DOMContentLoaded', function() {
    // Add initial lines
    addJournalLine();
    addJournalLine();
    
    // Event listeners
    document.getElementById('addLineBtn').addEventListener('click', addJournalLine);
    document.getElementById('closeModal').addEventListener('click', closeAccountModal);
    document.getElementById('accountSearch').addEventListener('input', filterAccounts);
    
    // Calculate balance on form changes
    document.addEventListener('input', calculateBalance);
});

function addJournalLine() {
    lineCounter++;
    const lineHtml = `
        <div class="entry-row grid grid-cols-12 gap-4 p-4 rounded-lg border border-gray-200" data-line="${lineCounter}">
            <div class="col-span-4">
                <input type="hidden" name="account_${lineCounter}" class="account-id">
                <input type="text" class="account-display w-full px-3 py-2 border border-gray-300 rounded-lg cursor-pointer" readonly placeholder="Select Account" onclick="openAccountModal(${lineCounter})">
            </div>
            <div class="col-span-3">
                <input type="text" name="description_${lineCounter}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Line description">
            </div>
            <div class="col-span-2">
                <input type="number" name="debit_${lineCounter}" step="0.01" min="0" class="debit-input w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="0.00" oninput="clearCredit(${lineCounter})">
            </div>
            <div class="col-span-2">
                <input type="number" name="credit_${lineCounter}" step="0.01" min="0" class="credit-input w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="0.00" oninput="clearDebit(${lineCounter})">
            </div>
            <div class="col-span-1">
                <button type="button" class="text-red-600 hover:text-red-800" onclick="removeLine(${lineCounter})">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        </div>
    `;
    document.getElementById('entryLines').insertAdjacentHTML('beforeend', lineHtml);
}

function removeLine(lineNumber) {
    const line = document.querySelector(`[data-line="${lineNumber}"]`);
    if (line) {
        line.remove();
        calculateBalance();
    }
}

function openAccountModal(lineNumber) {
    currentLineIndex = lineNumber;
    populateAccountList();
    document.getElementById('accountModal').classList.remove('hidden');
}

function closeAccountModal() {
    document.getElementById('accountModal').classList.add('hidden');
    currentLineIndex = null;
}

function populateAccountList() {
    const accountList = document.getElementById('accountList');
    accountList.innerHTML = '';
    
    accounts.forEach(account => {
        const accountHtml = `
            <div class="account-item p-3 border border-gray-200 rounded-lg mb-2 cursor-pointer hover:bg-blue-50" onclick="selectAccount(${account.id}, '${account.code}', '${account.name}', '${account.type}')">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="font-medium text-gray-900">${account.name}</div>
                        <div class="text-sm text-gray-500">${account.code} - ${account.type}</div>
                    </div>
                </div>
            </div>
        `;
        accountList.insertAdjacentHTML('beforeend', accountHtml);
    });
}

function filterAccounts() {
    const searchTerm = document.getElementById('accountSearch').value.toLowerCase();
    const accountItems = document.querySelectorAll('.account-item');
    
    accountItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function selectAccount(id, code, name, type) {
    if (currentLineIndex) {
        const line = document.querySelector(`[data-line="${currentLineIndex}"]`);
        line.querySelector('.account-id').value = id;
        line.querySelector('.account-display').value = `${code} - ${name}`;
        closeAccountModal();
    }
}

function clearCredit(lineNumber) {
    const line = document.querySelector(`[data-line="${lineNumber}"]`);
    const debitInput = line.querySelector(`input[name="debit_${lineNumber}"]`);
    const creditInput = line.querySelector(`input[name="credit_${lineNumber}"]`);
    
    if (debitInput.value) {
        creditInput.value = '';
    }
}

function clearDebit(lineNumber) {
    const line = document.querySelector(`[data-line="${lineNumber}"]`);
    const debitInput = line.querySelector(`input[name="debit_${lineNumber}"]`);
    const creditInput = line.querySelector(`input[name="credit_${lineNumber}"]`);
    
    if (creditInput.value) {
        debitInput.value = '';
    }
}

function calculateBalance() {
    let totalDebits = 0;
    let totalCredits = 0;
    
    document.querySelectorAll('.entry-row').forEach(line => {
        const debitInput = line.querySelector('input[name^="debit_"]');
        const creditInput = line.querySelector('input[name^="credit_"]');
        
        if (debitInput && debitInput.value) {
            totalDebits += parseFloat(debitInput.value) || 0;
        }
        if (creditInput && creditInput.value) {
            totalCredits += parseFloat(creditInput.value) || 0;
        }
    });
    
    const difference = Math.abs(totalDebits - totalCredits);
    const isBalanced = difference < 0.01; // Allow for small rounding differences
    
    // Update balance display
    document.getElementById('totalDebits').textContent = totalDebits.toFixed(2);
    document.getElementById('totalCredits').textContent = totalCredits.toFixed(2);
    document.getElementById('difference').textContent = difference.toFixed(2);
    
    const balanceCheck = document.getElementById('balanceCheck');
    const balanceIcon = document.getElementById('balanceIcon');
    const balanceText = document.getElementById('balanceText');
    const submitBtn = document.getElementById('submitBtn');
    
    if (isBalanced && totalDebits > 0) {
        balanceCheck.className = 'mt-6 p-4 rounded-lg balanced';
        balanceIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
        balanceIcon.className = 'w-6 h-6 mr-2 text-green-600';
        balanceText.textContent = 'Entry is balanced';
        balanceText.className = 'font-semibold text-green-600';
        submitBtn.disabled = false;
        submitBtn.className = 'action-btn bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-2xl hover-lift';
    } else {
        balanceCheck.className = 'mt-6 p-4 rounded-lg unbalanced';
        balanceIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
        balanceIcon.className = 'w-6 h-6 mr-2 text-red-600';
        balanceText.textContent = 'Entry is not balanced';
        balanceText.className = 'font-semibold text-red-600';
        submitBtn.disabled = true;
        submitBtn.className = 'action-btn bg-gray-400 text-white px-6 py-3 rounded-2xl cursor-not-allowed';
    }
}
</script>
{% endblock %}
